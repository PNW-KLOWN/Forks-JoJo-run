<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Forks Ave ‚Äî JoJos Run</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />

<style>
*{
  -webkit-touch-callout:none;
  -webkit-user-select:none;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
}
html,body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  background:#071021;
  overflow:hidden;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
}

#wrap{
  width:100vw;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}

canvas{
  width:100vw;
  max-width:520px;
  height:100vh;
  max-height:960px;
  background:#8fd3ff;
  image-rendering:pixelated;
  border-radius:14px;
  touch-action:none;
}

#hud{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  padding:8px 10px;
  background:rgba(0,0,0,.75);
  color:#fff;
  display:flex;
  justify-content:space-between;
  z-index:10;
  font-size:14px;
}

#controls{
  position:fixed;
  bottom:10px;
  left:0;
  right:0;
  display:flex;
  gap:8px;
  padding:0 10px;
  z-index:10;
}

.ctrl{
  flex:1;
  padding:14px 10px;
  font-size:16px;
  font-weight:800;
  border:none;
  border-radius:16px;
  background:#111827;
  color:white;
}

.ctrl.jump{ background:#16a34a; }
.ctrl.action{ background:#2563eb; }

.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:20;
}

.panel{
  width:92%;
  max-width:520px;
  background:#0f1e35;
  color:white;
  padding:18px;
  border-radius:18px;
}

.panel h1{ margin:0 0 10px; }
.panel p{ line-height:1.35; }

.panel button{
  width:100%;
  margin-top:10px;
  padding:14px;
  font-size:18px;
  font-weight:900;
  border:none;
  border-radius:16px;
  background:#2563eb;
  color:white;
}
.panel button.secondary{
  background:#1f2937;
}
</style>
</head>

<body>

<div id="hud">
  <div>üç∫ <span id="hudBeer">6</span> | üíµ $<span id="hudCash">0</span> | ‚è± <span id="hudTime">160</span></div>
  <button onclick="location.reload()">Reset</button>
</div>

<div id="wrap">
  <canvas id="game" width="360" height="640"></canvas>
</div>

<div id="controls">
  <button class="ctrl" id="left">‚¨Ö</button>
  <button class="ctrl jump" id="jump">JUMP</button>
  <button class="ctrl" id="right">‚û°</button>
  <button class="ctrl action" id="action">ACTION</button>
</div>

<div class="overlay" id="startScreen">
  <div class="panel">
    <h1>Forks Ave ‚Äî JoJos Run</h1>
    <p>The crew bus just dropped Tom off at the 76. He‚Äôs on a mission to reach Thriftway‚Äôs hot case before the tourists wipe out the chicken strips and JoJos.</p>
    <p>Talk to tourists first. Smart ones tip if you give directions. Annoying ones can be thrown.</p>
    <p>Defeat vampires, werewolves, and Sassy the Sasquatch to win.</p>
    <button id="startBtn">START</button>
    <button class="secondary" id="howBtn">CONTROLS / GOAL</button>
  </div>
</div>

<div class="overlay" id="howScreen" style="display:none;">
  <div class="panel">
    <h1>How to Play</h1>
    <p><b>Mobile:</b> Use on-screen buttons.</p>
    <p><b>Keyboard:</b> Arrow keys or A/D to move, W/Up to jump, Space/Enter = Action.</p>
    <p><b>Action button:</b> Talk, grab, throw, drink beer.</p>
    <p><b>Goal:</b> Defeat Sasquatch, enter Thriftway, win.</p>
    <button id="backBtn">BACK</button>
  </div>
</div>

<script>
/* ===== SECTION 1 JS: Core + Audio (NO GAMEPLAY YET) ===== */

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let running = false;

/* ---- AUDIO (THIS IS THE FIXED PART) ---- */
let audioCtx = null;
let musicTimer = null;
let noteIndex = 0;

const melody = [
  262,294,330,392,440,392,330,294,
  262,330,392,523,587,523,392,330
];

function startMusic(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  }
  if(audioCtx.state === "suspended"){
    audioCtx.resume();
  }
  if(musicTimer) return;

  musicTimer = setInterval(()=>{
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type="square";
    osc.frequency.value = melody[noteIndex++ % melody.length];
    gain.gain.value = 0.05;
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.12);
  }, 180);
}

/* ---- INPUT (touch + keyboard) ---- */
const input = { left:false, right:false };

function bindHold(id, prop){
  const el=document.getElementById(id);
  el.addEventListener("pointerdown", e=>{ e.preventDefault(); input[prop]=true; startMusic(); });
  el.addEventListener("pointerup",   e=>{ e.preventDefault(); input[prop]=false; });
  el.addEventListener("pointerleave",e=>{ e.preventDefault(); input[prop]=false; });
}

bindHold("left","left");
bindHold("right","right");

document.getElementById("jump").onclick = ()=>startMusic();
document.getElementById("action").onclick = ()=>startMusic();

window.addEventListener("keydown", e=>{
  startMusic();
  if(e.key==="ArrowLeft"||e.key==="a") input.left=true;
  if(e.key==="ArrowRight"||e.key==="d") input.right=true;
});
window.addEventListener("keyup", e=>{
  if(e.key==="ArrowLeft"||e.key==="a") input.left=false;
  if(e.key==="ArrowRight"||e.key==="d") input.right=false;
});

/* ---- SCREENS ---- */
document.getElementById("startBtn").onclick = ()=>{
  document.getElementById("startScreen").style.display="none";
  running=true;
  startMusic();
};
document.getElementById("howBtn").onclick = ()=>{
  document.getElementById("howScreen").style.display="flex";
};
document.getElementById("backBtn").onclick = ()=>{
  document.getElementById("howScreen").style.display="none";
};


</script>
<script>
/* =========================================================
   SECTION 2 ‚Äî FULL GAMEPLAY (NO FROGGER)
   - Mobile-first + keyboard
   - Detailed pixel sprites
   - Stores are door-only
   - Tourists: talk first, smart tips, annoying throwable
   - Enemies: vampires/werewolves, stomp logic fixed
   - Elk hazard
   - Boss arena: Sasquatch "Sassy"
   - Win screen
========================================================= */

/* ---------- Helpers ---------- */
function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
function aabb(a,b){
  return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;
}
function rect(x,y,w,h){ return {x,y,w,h}; }

/* ---------- Upgrade Section 1 input ---------- */
input.jumpTap = false;
input.actionTap = false;

const btnJump = document.getElementById("jump");
const btnAction = document.getElementById("action");

btnJump.addEventListener("pointerdown", e=>{ e.preventDefault(); input.jumpTap=true; startMusic(); }, {passive:false});
btnAction.addEventListener("pointerdown", e=>{ e.preventDefault(); input.actionTap=true; startMusic(); }, {passive:false});

window.addEventListener("keydown", e=>{
  if(e.repeat) return;
  if(e.key==="ArrowUp"||e.key==="w") input.jumpTap = true;
  if(e.key===" "||e.key==="Enter") input.actionTap = true;
});

/* ---------- HUD refs ---------- */
const hudBeer = document.getElementById("hudBeer");
const hudCash = document.getElementById("hudCash");
const hudTime = document.getElementById("hudTime");

/* ---------- Canvas state ---------- */
const WORLD_W = 2600;
const GROUND_Y = 560;
const GRAVITY = 2200;

/* ---------- Game state ---------- */
let paused = false;
let won = false;

let timeLeft = 160;
let cash = 0;

function setPaused(v){ paused = v; }

/* ---------- Speech bubble (simple, centered) ---------- */
const bubble = document.createElement("div");
bubble.style.position="fixed";
bubble.style.left="50%";
bubble.style.transform="translateX(-50%)";
bubble.style.bottom="120px";
bubble.style.width="min(520px, 92vw)";
bubble.style.background="#fff";
bubble.style.color="#0b1220";
bubble.style.borderRadius="16px";
bubble.style.padding="12px";
bubble.style.boxShadow="0 8px 24px rgba(0,0,0,.35)";
bubble.style.zIndex="30";
bubble.style.whiteSpace="pre-line";
bubble.style.display="none";
document.body.appendChild(bubble);

function showBubble(text){
  bubble.textContent=text;
  bubble.style.display="block";
}
function hideBubble(){
  bubble.style.display="none";
  bubble.textContent="";
}

/* ---------- Player: Tom ---------- */
const tom = {
  x: 90,
  y: GROUND_Y-96,
  w: 44,
  h: 96,
  vx: 0,
  vy: 0,
  onGround:false,
  big:true,
  beer:6,
  facing:1,
  carry:null
};

/* ---------- Camera ---------- */
let camX = 0;

/* ---------- Stores (door-only) ---------- */
const stores = [
  { key:"76",     name:"Evergreen 76",  x:  40, w: 220, color:"#9b1c1c", door:{dx: 95,  w: 34} },
  { key:"SHELL",  name:"Shell",         x: 330, w: 220, color:"#d4a300", door:{dx: 92,  w: 34} },
  { key:"CHINOOK",name:"Chinook Rx",    x: 610, w: 240, color:"#0f766e", door:{dx: 104, w: 34} },
  { key:"TRUE",   name:"True Value",    x: 910, w: 240, color:"#5b21b6", door:{dx: 104, w: 34} },
  { key:"TRANSIT",name:"Transit",       x: 1220,w: 220, color:"#334155", door:{dx: 92,  w: 34} },
  { key:"CARWASH",name:"Car Wash",      x: 1470,w: 210, color:"#1d4ed8", door:{dx: 88,  w: 34} },
  { key:"SASQ",   name:"Sasquatch Shop",x: 1730,w: 240, color:"#6d4c41", door:{dx: 104, w: 34} },
  { key:"THRIFT", name:"Thriftway",     x: 2020,w: 360, color:"#b50000", door:{dx: 160, w: 48} },
];

const BUILD_Y = GROUND_Y - 210;
const BUILD_H = 190;

function doorRect(s){ return rect(s.x + s.door.dx, GROUND_Y-84, s.door.w, 84); }

function storeAtDoor(){
  const tr = rect(tom.x,tom.y,tom.w,tom.h);
  for(const s of stores){
    if(aabb(tr, doorRect(s))) return s;
  }
  return null;
}

/* ---------- Tourists ---------- */
function makeTourist(x){
  return {
    x,
    y: GROUND_Y-82,
    w: 38,
    h: 82,
    vx: Math.random()<0.5 ? -40 : 40,
    alive:true,
    known:false,
    annoying:null,
    smart:false,
    throwable:false,
    sliding:false,
    slideV:0
  };
}
let tourists = [
  makeTourist(420),
  makeTourist(680),
  makeTourist(980),
  makeTourist(1320),
  makeTourist(1600),
];

/* Dumb + direction questions */
const dumbQs = [
  "‚ÄúWhen do the deer turn into elk?‚Äù",
  "‚ÄúWhere can we find Edward?‚Äù",
  "‚ÄúDo vampires sparkle in the shade or only in drizzle?‚Äù",
  "‚ÄúIs the Cullen house on Airbnb?‚Äù",
  "‚ÄúDo park rangers herd whales through Peugeot Sound?‚Äù",
  "‚ÄúIs Jacob available for birthday parties?‚Äù"
];

const directionQs = [
  { q:"‚ÄúHow do we get to Thriftway?‚Äù",
    correct:"Go down Forks Ave until the big red sign.",
    wrong:["Follow the whales through Peugeot Sound.",
           "Ask a vampire for Yelp directions.",
           "Wait for Edward to appear and lead you."] },
  { q:"‚ÄúWhere‚Äôs Chinook Pharmacy?‚Äù",
    correct:"Stay on the main strip‚Äîkeep walking.",
    wrong:["Turn where the deer become elk.",
           "Cross into La Push and howl twice.",
           "It‚Äôs behind the sparkle treaty line."] },
  { q:"‚ÄúWhere‚Äôs the Transit Center?‚Äù",
    correct:"Keep to Forks Ave‚Äîwatch for the bus stop.",
    wrong:["Summon a werewolf rideshare.",
           "Ask Sassy. He runs dispatch.",
           "Go back to the 76 and request a teleport."] },
];

/* ---------- Enemies ---------- */
function makeEnemy(type,x){
  return {
    type,
    x,
    y: GROUND_Y-76,
    w: 42,
    h: 76,
    vx: type==="werewolf"? 95 : 75,
    vy: 0,
    winged: type==="vampire",
    alive:true
  };
}
let enemies = [
  makeEnemy("vampire", 760),
  makeEnemy("werewolf", 1050),
  makeEnemy("vampire", 1380),
  makeEnemy("werewolf", 1620),
];

/* ---------- Elk hazard ---------- */
const elk = { active:false, x:0, y:GROUND_Y-54, w:90, h:48, vx:-560 };
function maybeSpawnElk(){
  if(inBossArena || elk.active) return;
  if(tom.x > 1150 && Math.random() < 0.012){
    elk.active = true;
    elk.x = tom.x + 520;
  }
}
function updateElk(dt){
  if(!elk.active) return;
  elk.x += elk.vx*dt;
  if(elk.x < tom.x - 900) elk.active=false;

  const tr = rect(tom.x,tom.y,tom.w,tom.h);
  const er = rect(elk.x,elk.y,elk.w,elk.h);
  if(aabb(tr,er)){
    const stomp = tom.vy>120 && (tom.y+tom.h - elk.y) < 28;
    if(stomp){
      elk.active=false;
      tom.vy = -720;
    }else{
      if(tom.big) tom.big=false;
      else resetTo76();
      elk.active=false;
    }
  }
}

/* ---------- Boss arena ---------- */
let inBossArena = false;

const sassy = {
  active:false, started:false, hp:5,
  x:2140, y:GROUND_Y-140, w:110, h:140,
  vx:0, vy:0, onGround:false, jumpT:0.9
};

function checkBossArenaEntry(){
  if(inBossArena) return;
  if(tom.x > 1950){
    inBossArena = true;
    // clear street actors
    enemies.forEach(e=>e.alive=false);
    tourists.forEach(t=>t.alive=false);
  }
}

function startBoss(){
  sassy.active=true;
  sassy.started=true;
  sassy.hp=5;
  sassy.x=2140;
  sassy.y=GROUND_Y-sassy.h;
  sassy.vx=-220;
  sassy.vy=0;
  sassy.onGround=true;
  sassy.jumpT=0.9;
}

function updateBoss(dt){
  if(!sassy.active) return;
  const dir = Math.sign(tom.x - sassy.x) || 1;
  sassy.vx = dir * 280;

  sassy.jumpT -= dt;
  if(sassy.jumpT<=0 && sassy.onGround){
    sassy.vy = -980;
    sassy.onGround=false;
    sassy.jumpT = 0.6 + Math.random()*0.7;
  }

  sassy.vy += GRAVITY*dt;
  sassy.x += sassy.vx*dt;
  sassy.y += sassy.vy*dt;

  sassy.x = clamp(sassy.x, 1960, 2360);
  if(sassy.y >= GROUND_Y - sassy.h){
    sassy.y = GROUND_Y - sassy.h;
    sassy.vy = 0;
    sassy.onGround = true;
  }

  // collision
  const tr = rect(tom.x,tom.y,tom.w,tom.h);
  const br = rect(sassy.x,sassy.y,sassy.w,sassy.h);
  if(aabb(tr,br)){
    const stomp = tom.vy>120 && (tom.y+tom.h - sassy.y) < 30;
    if(stomp){
      sassy.hp -= 1;
      tom.vy = -760;
      if(sassy.hp<=0) sassy.active=false;
    }else{
      if(tom.big){
        tom.big=false;
        tom.vy=-540;
        tom.vx = -dir*520;
      }else{
        resetTo76();
      }
    }
  }
}

/* ---------- Store interactions ---------- */
let mode = "RUN"; // RUN | TOURIST | STORE | WIN
let activeTourist=null;
let activeStore=null;
let answerChoices=[];
let answerIndex=0;
let correctIndex=0;

function closeInteraction(){
  mode="RUN";
  activeTourist=null;
  activeStore=null;
  answerChoices=[];
  hideBubble();
  setPaused(false);
}

function renderChoices(){
  let s="";
  for(let i=0;i<answerChoices.length;i++){
    s += (i===answerIndex ? "‚ñ∂ " : "  ") + answerChoices[i] + "\n";
  }
  return s.trimEnd();
}

function openTourist(t){
  mode="TOURIST";
  setPaused(true);
  activeTourist=t;
  t.known=true;

  if(t.annoying===null){
    t.annoying = Math.random() < 0.55;
    t.smart = !t.annoying;
    t.throwable = t.annoying;
  }

  if(t.annoying){
    const q = dumbQs[Math.floor(Math.random()*dumbQs.length)];
    showBubble(q + "\n\nACTION to continue");
    answerChoices=[];
    return;
  }

  const dq = directionQs[Math.floor(Math.random()*directionQs.length)];
  const choices = [dq.correct, ...dq.wrong];
  for(let i=choices.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [choices[i],choices[j]]=[choices[j],choices[i]];
  }
  answerChoices = choices;
  answerIndex = 0;
  correctIndex = choices.indexOf(dq.correct);

  showBubble(dq.q + "\n\n" + renderChoices() + "\n\n‚Üê/‚Üí choose  ‚Ä¢  ACTION confirm  ‚Ä¢  JUMP closes");
}

function openStore(s){
  mode="STORE";
  setPaused(true);
  activeStore=s;

  let text = `üõí ${s.name}\n`;
  if(s.key==="SHELL")   text += "1) Buy beer case (+6) ‚Äî $10\n";
  if(s.key==="CHINOOK") text += "1) Blister cream ‚Äî $8\n";
  if(s.key==="TRUE")    text += "1) Ammo (+3) ‚Äî $9\n";
  if(s.key==="SASQ")    text += "1) Earrings (wife) ‚Äî $12 (+15s)\n";
  if(s.key==="CARWASH") text += "1) Wash car +$5 (free)\n";
  if(s.key==="TRANSIT") text += "1) Bus to Thriftway zone ‚Äî $20\n";
  if(s.key==="76")      text += "1) Nothing. Just fumes and regret.\n";
  if(s.key==="THRIFT"){
    if(!inBossArena) text += "Parking lot ahead‚Ä¶\n";
    else text += sassy.active ? "Door locked until Sassy is defeated.\n" : "Door unlocked.\n";
  }
  text += "\nACTION buys option 1.  JUMP closes.";
  showBubble(text);
}

function buyStore(){
  const s=activeStore;
  if(!s) return;

  if(s.key==="SHELL" && cash>=10){ cash-=10; tom.beer+=6; }
  if(s.key==="CHINOOK" && cash>=8){ cash-=8; }
  if(s.key==="TRUE" && cash>=9){ cash-=9; }
  if(s.key==="SASQ" && cash>=12){ cash-=12; timeLeft+=15; }
  if(s.key==="CARWASH"){ cash += 5; }
  if(s.key==="TRANSIT" && cash>=20 && !inBossArena){
    cash -= 20;
    tom.x = 1880;
    tom.y = GROUND_Y - tom.h;
    tom.vx = tom.vy = 0;
  }
}

/* ---------- Reset logic ---------- */
function resetTo76(){
  tom.x = 90;
  tom.y = GROUND_Y - tom.h;
  tom.vx = tom.vy = 0;
  tom.onGround=false;
  tom.big=true; // he can drink if small, but reset is a full restart feel
  inBossArena=false;
  sassy.active=false;
  sassy.started=false;
  timeLeft = 160;
  cash = 0;
  tom.beer = 6;
  // respawn actors
  enemies = [
    makeEnemy("vampire", 760),
    makeEnemy("werewolf", 1050),
    makeEnemy("vampire", 1380),
    makeEnemy("werewolf", 1620),
  ];
  tourists = [
    makeTourist(420), makeTourist(680), makeTourist(980), makeTourist(1320), makeTourist(1600),
  ];
}

/* ---------- Throw tourist ---------- */
function throwTourist(t){
  t.sliding=true;
  t.slideV = 640 * tom.facing;
  tom.carry=null;
}

/* ---------- Enemy stomp check ---------- */
function stompOn(entityY){
  return tom.vy > 120 && (tom.y + tom.h - entityY) < 34;
}

/* ---------- Update loops ---------- */
function updateTom(dt){
  const speed = 240;
  tom.vx = 0;

  if(input.left){ tom.vx=-speed; tom.facing=-1; }
  if(input.right){ tom.vx=speed; tom.facing=1; }

  if(input.jumpTap){
    input.jumpTap=false;
    if(paused && (mode==="STORE"||mode==="TOURIST")){ closeInteraction(); return; }
    if(tom.onGround){
      tom.vy = -860;
      tom.onGround=false;
    }
  }

  tom.vy += GRAVITY*dt;
  tom.x += tom.vx*dt;
  tom.y += tom.vy*dt;

  if(tom.y >= GROUND_Y - tom.h){
    tom.y = GROUND_Y - tom.h;
    tom.vy = 0;
    tom.onGround=true;
  }

  tom.x = clamp(tom.x, 0, WORLD_W - tom.w);
}

function updateEnemies(dt){
  for(const e of enemies){
    if(!e.alive) continue;

    if(e.type==="vampire" && e.winged && Math.random()<0.01){
      e.vy = -740;
    }

    e.vy += GRAVITY*dt;
    e.x += e.vx*dt;
    e.y += e.vy*dt;

    if(e.x < 650) e.vx = Math.abs(e.vx);
    if(e.x > 1700) e.vx = -Math.abs(e.vx);

    if(e.y >= GROUND_Y - e.h){
      e.y = GROUND_Y - e.h;
      e.vy = 0;
    }

    const tr = rect(tom.x,tom.y,tom.w,tom.h);
    const er = rect(e.x,e.y,e.w,e.h);

    if(aabb(tr,er)){
      if(stompOn(e.y)){
        if(e.type==="vampire" && e.winged){
          e.winged=false;
        }else{
          e.alive=false;
        }
        tom.vy = -680;
      }else{
        if(tom.big){
          tom.big=false;
        }else{
          resetTo76();
        }
      }
    }
  }
}

function updateTourists(dt){
  for(const t of tourists){
    if(!t.alive) continue;

    if(tom.carry === t){
      t.x = tom.x + (tom.facing>0 ? 18 : -18);
      t.y = tom.y + 10;
      continue;
    }

    if(t.sliding){
      t.x += t.slideV*dt;
      t.y = GROUND_Y - t.h;

      for(const e of enemies){
        if(!e.alive) continue;
        if(aabb(rect(t.x,t.y,t.w,t.h), rect(e.x,e.y,e.w,e.h))){
          e.alive=false;
          t.alive=false;
        }
      }

      if(Math.abs(t.x - tom.x) > 900) t.alive=false;
      continue;
    }

    t.x += t.vx*dt;
    if(Math.random()<0.01) t.vx *= -1;
    t.x = clamp(t.x, 200, 1850);
  }
}

/* ---------- Action button (unified) ---------- */
function doAction(){
  // Paused interactions
  if(paused){
    if(mode==="STORE"){
      buyStore();
      closeInteraction();
      return;
    }
    if(mode==="TOURIST"){
      if(!activeTourist){ closeInteraction(); return; }
      if(activeTourist.annoying){
        closeInteraction();
        return;
      }
      const correct = (answerIndex === correctIndex);
      if(correct) cash += 8 + Math.floor(Math.random()*6);
      else timeLeft = Math.max(0, timeLeft - 3);
      closeInteraction();
      return;
    }
  }

  // If holding tourist: throw
  if(tom.carry){
    throwTourist(tom.carry);
    return;
  }

  // Door: store menu
  const s = storeAtDoor();
  if(s){
    if(s.key==="THRIFT" && inBossArena && sassy.active){
      openStore(s);
      return;
    }
    if(s.key==="THRIFT" && inBossArena && !sassy.active){
      // win check handled elsewhere; still allow menu
      openStore(s);
      return;
    }
    openStore(s);
    return;
  }

  // Tourist interaction
  for(const t of tourists){
    if(!t.alive) continue;
    if(aabb(rect(tom.x,tom.y,tom.w,tom.h), rect(t.x,t.y,t.w,t.h))){
      if(!t.known){
        openTourist(t);
        return;
      }
      if(t.throwable){
        tom.carry = t;
        return;
      }
      openTourist(t);
      return;
    }
  }

  // Beer use anytime: if small and has beer
  if(!tom.big && tom.beer>0){
    tom.beer -= 1;
    tom.big = true;
  }
}

/* Answer nav: use Left/Right while paused in tourist question */
function answerNav(dir){
  if(!paused || mode!=="TOURIST" || answerChoices.length===0) return;
  answerIndex = (answerIndex + dir + answerChoices.length) % answerChoices.length;
  const q = bubble.textContent.split("\n\n")[0];
  showBubble(q + "\n\n" + renderChoices() + "\n\n‚Üê/‚Üí choose  ‚Ä¢  ACTION confirm  ‚Ä¢  JUMP closes");
}

/* Keyboard answer nav */
window.addEventListener("keydown", e=>{
  if(paused && mode==="TOURIST" && answerChoices.length){
    if(e.key==="ArrowLeft"||e.key==="a") answerNav(-1);
    if(e.key==="ArrowRight"||e.key==="d") answerNav(+1);
  }
});

/* ---------- Drawing ---------- */
function px(x,y,w,h,c){ ctx.fillStyle=c; ctx.fillRect(x,y,w,h); }

function drawStores(){
  ctx.save();
  ctx.translate(-camX,0);
  for(const s of stores){
    px(s.x, BUILD_Y, s.w, BUILD_H, s.color);
    px(s.x, BUILD_Y, s.w, 10, "rgba(0,0,0,.25)");
    ctx.fillStyle="rgba(255,255,255,.92)";
    ctx.font="bold 14px system-ui";
    ctx.textAlign="center";
    ctx.fillText(s.name, s.x + s.w/2, BUILD_Y + 26);
    for(let i=0;i<Math.floor(s.w/70);i++){
      px(s.x+16+i*70, BUILD_Y+54, 42, 22, "rgba(255,255,255,.18)");
    }
    const d = doorRect(s);
    px(d.x, d.y, d.w, d.h, "#111827");
    px(d.x+4, d.y+14, d.w-8, 18, "rgba(255,255,255,.25)");
  }
  ctx.restore();
}

function drawTom(x,y){
  // logger sprite: hardhat, beard, flannel, caulks
  px(x+8, y+92, 28, 6, "rgba(0,0,0,.25)");
  px(x+8, y+6, 28, 10, "#ffcc00");
  px(x+6, y+14, 32, 6, "#eab308");
  px(x+12, y+20, 20, 18, "#f2c9a0");
  px(x+12, y+34, 20, 8, "#2b2b2b");
  px(x+16, y+26, 4, 4, "#111827");
  px(x+24, y+26, 4, 4, "#111827");
  px(x+10, y+40, 24, 28, "#b22222");
  px(x+10, y+46, 24, 4, "#1e3a8a");
  px(x+10, y+54, 24, 4, "#1e3a8a");
  px(x+10, y+62, 24, 3, "#1e3a8a");
  px(x+4,  y+44, 6, 22, "#b22222");
  px(x+34, y+44, 6, 22, "#b22222");
  px(x+4,  y+66, 6, 6, "#f2c9a0");
  px(x+34, y+66, 6, 6, "#f2c9a0");
  px(x+12, y+68, 10, 18, "#1f2937");
  px(x+22, y+68, 10, 18, "#1f2937");
  px(x+10, y+86, 12, 8, "#111827");
  px(x+22, y+86, 12, 8, "#111827");
  px(x+12, y+94, 8, 2, "#9ca3af");
  px(x+24, y+94, 8, 2, "#9ca3af");
  if(!tom.big) px(x+4, y+6, 36, 90, "rgba(255,255,255,.12)");
}

function drawTourist(t,x,y){
  px(x+8,y+10,26,8, t.annoying ? "#ff7a18" : "#16a34a");
  px(x+12,y+18,18,16,"#f2c9a0");
  px(x+16,y+24,3,3,"#111827");
  px(x+23,y+24,3,3,"#111827");
  px(x+10,y+34,22,24,"#64748b");
  px(x+14,y+40,14,8,"#111827");
  px(x+4,y+40,8,12,"#94a3b8");
  px(x+12,y+58,9,18,"#0f172a");
  px(x+21,y+58,9,18,"#0f172a");
  px(x+12,y+76,9,6,"#111827");
  px(x+21,y+76,9,6,"#111827");
}

function drawWerewolf(x,y){
  px(x+6,y+14,32,38,"#6b4a2e");
  px(x+10,y+22,24,18,"#4b2f1a");
  px(x+26,y+28,12,8,"#2b1a0f");
  px(x+14,y+28,3,3,"#111827");
  px(x+20,y+28,3,3,"#111827");
  px(x+10,y+52,12,18,"#111827");
  px(x+22,y+52,12,18,"#111827");
  px(x+8,y+70,14,6,"#111827");
  px(x+22,y+70,14,6,"#111827");
}

function drawVampire(e,x,y){
  if(e.winged){
    px(x-8,y+18,10,18,"rgba(0,0,0,.35)");
    px(x+40,y+18,10,18,"rgba(0,0,0,.35)");
  }
  px(x+8,y+14,28,40,"#3b1d5c");
  px(x+14,y+20,16,14,"#f3e8ff");
  px(x+17,y+24,3,3,"#111827");
  px(x+24,y+24,3,3,"#111827");
  px(x+20,y+32,4,3,"#7c2d12");
  px(x+12,y+54,10,16,"#111827");
  px(x+22,y+54,10,16,"#111827");
  px(x+10,y+70,12,6,"#111827");
  px(x+22,y+70,12,6,"#111827");
}

function drawElk(){
  if(!elk.active) return;
  px(elk.x-camX, elk.y, elk.w, elk.h, "#c68642");
  px(elk.x-camX+14, elk.y+14, 20, 6, "rgba(0,0,0,.22)");
  px(elk.x-camX+60, elk.y+6, 10, 10, "#8b5a2b");
}

function drawSassy(){
  const x = sassy.x-camX, y=sassy.y;
  px(x+8,y+10,94,120,"#3b2f2f");
  px(x+24,y+30,60,38,"#2b1f1f");
  px(x+38,y+42,8,8,"#111827");
  px(x+66,y+42,8,8,"#111827");
  px(x+46,y+62,28,8,"#111827");
  px(x-8,y+44,20,50,"#3b2f2f");
  px(x+102,y+44,20,50,"#3b2f2f");
  ctx.fillStyle="rgba(255,255,255,.92)";
  ctx.font="bold 14px system-ui";
  ctx.textAlign="left";
  ctx.fillText("SASSY HP: "+sassy.hp, x, y-8);
}

/* ---------- Win ---------- */
function win(){
  if(won) return;
  won=true;
  setPaused(true);
  showBubble("HOT CASE SECURED.\n\nTom gets the chicken strips and JoJos.\nThe tourists are still asking about Edward.\n\nReset to play again.");
}

/* ---------- Main loop replace Section 1 placeholder ---------- */
let last = performance.now();

function gameLoop(now){
  const dt = clamp((now-last)/1000, 0, 1/20);
  last = now;

  ctx.fillStyle="#8fd3ff";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // ground/trees
  ctx.fillStyle="#1f7a3a";
  ctx.fillRect(0,120,canvas.width,70);
  ctx.fillStyle="#14532d";
  ctx.fillRect(0,150,canvas.width,50);
  ctx.fillStyle="#2f7d2a";
  ctx.fillRect(0,GROUND_Y,canvas.width,80);
  ctx.fillStyle="rgba(255,255,255,.35)";
  ctx.fillRect(0,GROUND_Y-14,canvas.width,6);

  if(running && !won){
    if(!paused){
      timeLeft = Math.max(0, timeLeft - dt);
      if(timeLeft<=0){
        setPaused(true);
        showBubble("Time‚Äôs up.\nThe hot case is gone.\n\nReset to try again.");
      }

      updateTom(dt);
      camX = clamp(tom.x - 170, 0, WORLD_W - canvas.width);

      if(!inBossArena){
        updateEnemies(dt);
        updateTourists(dt);
        maybeSpawnElk();
        updateElk(dt);
      }else{
        if(!sassy.started) startBoss();
        if(sassy.active) updateBoss(dt);
      }

      checkBossArenaEntry();
    }

    // handle action tap
    if(input.actionTap){
      input.actionTap=false;
      doAction();
    }

    // answer nav uses left/right while paused
    if(paused && mode==="TOURIST" && answerChoices.length){
      if(input.left){ answerNav(-1); input.left=false; }
      if(input.right){ answerNav(+1); input.right=false; }
    }

    // win condition: in boss arena, boss defeated, at thrift door
    const thrift = stores.find(s=>s.key==="THRIFT");
    if(thrift && inBossArena && !sassy.active){
      if(aabb(rect(tom.x,tom.y,tom.w,tom.h), doorRect(thrift))){
        win();
      }
    }

    // tempo ramp
    if(inBossArena) setTempo(110);
    else if(tom.x > 1800) setTempo(135);
    else if(tom.x > 1400) setTempo(155);
    else setTempo(180);
  }

  // draw buildings behind actors
  drawStores();

  // draw actors
  ctx.save();
  ctx.translate(-camX,0);

  // enemies + tourists only before boss arena
  if(!inBossArena){
    for(const e of enemies){
      if(!e.alive) continue;
      if(e.type==="werewolf") drawWerewolf(e.x,e.y);
      else drawVampire(e,e.x,e.y);
    }
    for(const t of tourists){
      if(!t.alive) continue;
      drawTourist(t, t.x, t.y);
    }
    drawElk();
  }else{
    // boss arena vibe overlay
    ctx.fillStyle="rgba(0,0,0,.07)";
    ctx.fillRect(camX,0,canvas.width,canvas.height);
    if(sassy.active) drawSassy();
  }

  drawTom(tom.x, tom.y);

  ctx.restore();

  // HUD
  hudBeer.textContent = tom.beer;
  hudCash.textContent = cash;
  hudTime.textContent = Math.floor(timeLeft);

  requestAnimationFrame(gameLoop);
}

/* Replace the old loop by starting our gameplay loop */
requestAnimationFrame(gameLoop);
</script>

</body>
</html>
