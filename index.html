<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Forks Ave ‚Äî JoJos Run</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<style>
  *{-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#071021;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}
  #wrap{width:100vw;height:100vh;display:flex;align-items:center;justify-content:center}
  canvas{width:100vw;max-width:520px;height:100vh;max-height:960px;background:#8fd3ff;border-radius:14px;image-rendering:pixelated;touch-action:none}
  #hud{position:fixed;top:0;left:0;right:0;padding:8px 10px;background:rgba(0,0,0,.78);color:#fff;display:flex;justify-content:space-between;align-items:center;z-index:50;font-size:14px;box-sizing:border-box}
  #hud .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  #hud button{border:none;border-radius:12px;padding:8px 10px;background:#1f2937;color:#fff;font-weight:900}
  #controls{position:fixed;left:0;right:0;bottom:10px;display:flex;gap:8px;padding:0 10px;z-index:50;box-sizing:border-box}
  .ctrl{flex:1;border:none;border-radius:16px;padding:14px 10px;font-size:16px;font-weight:950;color:#fff;background:#111827;touch-action:none}
  .ctrl.jump{background:#16a34a}
  .ctrl.action{background:#2563eb}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:9999}
  .panel{width:92%;max-width:560px;background:#0f1e35;color:#fff;border-radius:18px;padding:18px;box-sizing:border-box}
  .panel h1{margin:0 0 10px;font-size:26px}
  .panel p{margin:8px 0;line-height:1.35}
  .panel .btn{width:100%;margin-top:12px;border:none;border-radius:16px;padding:14px;font-size:18px;font-weight:950;background:#2563eb;color:#fff}
  .panel .btn.secondary{background:#1f2937}
  #bubble{position:fixed;left:50%;transform:translateX(-50%);bottom:118px;width:min(520px,92vw);background:#fff;color:#0b1220;border-radius:16px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);z-index:60;display:none;white-space:pre-line;box-sizing:border-box;pointer-events:none}
</style>
</head>

<body>
<div id="hud">
  <div class="row">
    <span>üç∫ <b id="hudBeer">6</b></span>
    <span>üíµ $<b id="hudCash">0</b></span>
    <span>üî´ <b id="hudAmmo">0</b></span>
    <span>‚è± <b id="hudTime">160</b>s</span>
    <span>üìç <b id="hudZone">FORKS AVE</b></span>
  </div>
  <div class="row"><button id="btnReset" type="button">Reset</button></div>
</div>

<div id="wrap"><canvas id="game" width="360" height="640"></canvas></div>

<div id="controls">
  <button class="ctrl" id="btnLeft" type="button">‚¨Ö</button>
  <button class="ctrl jump" id="btnJump" type="button">JUMP</button>
  <button class="ctrl" id="btnRight" type="button">‚û°</button>
  <button class="ctrl action" id="btnAction" type="button">ACTION</button>
</div>

<div id="bubble"></div>

<div class="overlay" id="startOverlay">
  <div class="panel">
    <h1>Forks Ave ‚Äî JoJos Run</h1>
    <p><b>Story:</b> The crew bus just dropped Tom off at the 76. Reach Thriftway‚Äôs hot case for chicken strips + JoJos before tourists clean it out.</p>
    <p><b>Tourists:</b> Talk first. Smart tourists tip only if you answer directions right (only once, then they leave). Annoying tourists ask dumb Twilight questions ‚Äî those are throwable.</p>
    <p><b>Beer:</b> Big hit ‚Üí small (half-sized). Small hit ‚Üí back to 76. If small + beer, ACTION drinks first.</p>
    <button class="btn" id="startBtn" type="button">START</button>
    <button class="btn secondary" id="howBtn" type="button">CONTROLS / GOAL</button>
  </div>
</div>

<div class="overlay" id="howOverlay" style="display:none;">
  <div class="panel">
    <h1>Controls / Goal</h1>
    <p><b>Mobile:</b> On-screen buttons.</p>
    <p><b>Keyboard:</b> A/D or ‚Üê/‚Üí move, W/‚Üë jump, Space/Enter = ACTION, Esc closes dialogs.</p>
    <p><b>One ACTION priority:</b> 1) Drink beer (if small) ‚Ä¢ 2) Tourist ‚Ä¢ 3) Throw ‚Ä¢ 4) Door ‚Ä¢ 5) Shoot</p>
    <p><b>Upgrades:</b> Team Jacob Hat (76) doubles tips. Common Sense Cream (Chinook) gives 5 seconds invincible.</p>
    <button class="btn" id="backBtn" type="button">BACK</button>
  </div>
</div>

<script>
/* ===== Safety ===== */
document.addEventListener("contextmenu", e=>e.preventDefault());
document.addEventListener("selectstart", e=>e.preventDefault());

/* ===== Canvas ===== */
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

const hudBeer=document.getElementById("hudBeer");
const hudCash=document.getElementById("hudCash");
const hudAmmo=document.getElementById("hudAmmo");
const hudTime=document.getElementById("hudTime");
const hudZone=document.getElementById("hudZone");

const bubble=document.getElementById("bubble");
function showBubble(t){ bubble.style.display="block"; bubble.textContent=t; }
function hideBubble(){ bubble.style.display="none"; bubble.textContent=""; }

/* ===== State ===== */
let running=false, paused=false, won=false;
function setPaused(v){ paused=v; }

/* ===== Audio ===== */
let audioCtx=null, musicTimer=null, tempoMs=165, noteIndex=0, audioUnlocked=false;
const melody=[262,294,330,392,440,392,330,294,262,330,392,523,587,523,392,330,294,330,370,440,494,440,370,330,262,294,330,392,440,523,494,392];
function ensureAudio(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==="suspended") audioCtx.resume(); }
function playTone(freq,dur=0.10,vol=0.05,type="square"){
  if(!audioCtx) return;
  const osc=audioCtx.createOscillator(), gain=audioCtx.createGain();
  osc.type=type; osc.frequency.value=freq;
  gain.gain.value=vol;
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime+dur);
}
function startMusic(){
  if(!audioUnlocked||musicTimer) return;
  musicTimer=setInterval(()=>{ ensureAudio(); playTone(melody[noteIndex++%melody.length],0.12,0.035,"square"); }, tempoMs);
}
function setTempo(ms){
  ms=Math.max(110,Math.min(220,ms|0));
  if(ms===tempoMs) return;
  tempoMs=ms;
  if(musicTimer){ clearInterval(musicTimer); musicTimer=null; }
  startMusic();
}
function unlockAudio(){ if(audioUnlocked) return; audioUnlocked=true; ensureAudio(); startMusic(); }
function sfxJump(){ playTone(740,0.07,0.06,"square"); }
function sfxStomp(){ playTone(220,0.08,0.07,"square"); }
function sfxHit(){ playTone(160,0.10,0.07,"sawtooth"); }
function sfxCoin(){ playTone(880,0.06,0.05,"square"); playTone(1174,0.06,0.04,"square"); }
function sfxThrow(){ playTone(330,0.06,0.06,"square"); }
function sfxShoot(){ playTone(980,0.04,0.05,"square"); playTone(490,0.06,0.04,"square"); }

/* ===== Input (edge-triggered) ===== */
const input={left:false,right:false,jump:false,action:false};
const pressed={left:false,right:false,jump:false,action:false};
function stepPressed(){
  pressed.left  = input.left  && !stepPressed.pL;
  pressed.right = input.right && !stepPressed.pR;
  pressed.jump  = input.jump  && !stepPressed.pJ;
  pressed.action= input.action&& !stepPressed.pA;
  stepPressed.pL=input.left; stepPressed.pR=input.right; stepPressed.pJ=input.jump; stepPressed.pA=input.action;
}
stepPressed.pL=stepPressed.pR=stepPressed.pJ=stepPressed.pA=false;

function bindHold(el,key){
  el.addEventListener("pointerdown",(e)=>{e.preventDefault(); input[key]=true; unlockAudio();},{passive:false});
  el.addEventListener("pointerup",(e)=>{e.preventDefault(); input[key]=false;},{passive:false});
  el.addEventListener("pointerleave",()=>{input[key]=false;});
  el.addEventListener("pointercancel",()=>{input[key]=false;});
}
bindHold(document.getElementById("btnLeft"),"left");
bindHold(document.getElementById("btnRight"),"right");
bindHold(document.getElementById("btnJump"),"jump");
bindHold(document.getElementById("btnAction"),"action");

window.addEventListener("keydown",(e)=>{
  if(e.repeat) return;
  unlockAudio();
  const k=e.key;
  if(k==="ArrowLeft"||k==="a") input.left=true;
  if(k==="ArrowRight"||k==="d") input.right=true;
  if(k==="ArrowUp"||k==="w") input.jump=true;
  if(k===" "||k==="Enter") input.action=true;
  if(k==="Escape"){ if(paused) closeInteraction(); }
});
window.addEventListener("keyup",(e)=>{
  const k=e.key;
  if(k==="ArrowLeft"||k==="a") input.left=false;
  if(k==="ArrowRight"||k==="d") input.right=false;
  if(k==="ArrowUp"||k==="w") input.jump=false;
  if(k===" "||k==="Enter") input.action=false;
});

/* ===== UI ===== */
window.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("btnReset").addEventListener("click", ()=>location.reload());
  document.getElementById("startBtn").addEventListener("click", ()=>{
    document.getElementById("startOverlay").style.display="none";
    running=true; unlockAudio();
  });
  document.getElementById("howBtn").addEventListener("click", ()=>{
    document.getElementById("howOverlay").style.display="flex";
  });
  document.getElementById("backBtn").addEventListener("click", ()=>{
    document.getElementById("howOverlay").style.display="none";
  });
});

/* ===== Helpers ===== */
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function rect(x,y,w,h){ return {x,y,w,h}; }
function aabb(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }
function px(x,y,w,h,c){ ctx.fillStyle=c; ctx.fillRect(x,y,w,h); }  // ‚úÖ FIXED
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

/* ===== World ===== */
const W=canvas.width, H=canvas.height;
const GROUND_Y=560, GRAVITY=2200;
const BUILD_Y=GROUND_Y-210, BUILD_H=190;
let timeLeft=160, cash=0, camX=0, inBossArena=false;
function sx(wx){ return wx-camX; }

/* ===== Upgrades/timers ===== */
let invincibleTimer=0;
let tipMultiplier=1;
let speechTimer=0;

/* ===== Stores ===== */
const stores=[
  { key:"76",     name:"Evergreen 76",   x:  40, w:220, color:"#9b1c1c", door:{dx:95,w:34} },
  { key:"SHELL",  name:"Shell",          x: 330, w:220, color:"#d4a300", door:{dx:92,w:34} },
  { key:"CHINOOK",name:"Chinook Rx",     x: 610, w:240, color:"#0f766e", door:{dx:104,w:34} },
  { key:"TRUE",   name:"True Value",     x: 910, w:240, color:"#5b21b6", door:{dx:104,w:34} },
  { key:"TRANSIT",name:"Transit",        x:1220, w:220, color:"#334155", door:{dx:92,w:34} },
  { key:"CARWASH",name:"Car Wash",       x:1470, w:210, color:"#1d4ed8", door:{dx:88,w:34} },
  { key:"SASQ",   name:"Sasquatch Shop", x:1730, w:240, color:"#6d4c41", door:{dx:104,w:34} },
  { key:"THRIFT", name:"Thriftway",      x:2020, w:360, color:"#b50000", door:{dx:160,w:48} },
];
let WORLD_W=stores.reduce((m,s)=>Math.max(m,s.x+s.w),0)+260;
function doorRect(s){ return rect(s.x+s.door.dx, GROUND_Y-84, s.door.w, 84); }

/* ===== Tom (small is half size) ===== */
const TOM_BIG={w:44,h:96};
const TOM_SMALL={w:22,h:48};
const TOM_JUMP_VY=-1040;

const tom={
  x:90,y:GROUND_Y-TOM_BIG.h, prevX:90,prevY:GROUND_Y-TOM_BIG.h,
  w:TOM_BIG.w,h:TOM_BIG.h, vx:0,vy:0,onGround:false,
  big:true,beer:6,ammo:0, facing:1, carry:null, hurt:0, fireCD:0
};
function setTomSize(isBig){
  const foot=tom.y+tom.h;
  tom.big=isBig;
  if(isBig){ tom.w=TOM_BIG.w; tom.h=TOM_BIG.h; }
  else{ tom.w=TOM_SMALL.w; tom.h=TOM_SMALL.h; }
  tom.y=foot-tom.h;
}

/* ===== NPCs/Enemies ===== */
function makeTourist(x){
  return {x,y:GROUND_Y-82,w:38,h:82,vx:(Math.random()<0.5?-55:55),alive:true,known:false,annoying:null,throwable:false,sliding:false,slideV:0,tipped:false,leaving:false,qText:""};
}
let tourists=[makeTourist(420),makeTourist(680),makeTourist(980),makeTourist(1320),makeTourist(1600)];

function makeEnemy(type,x){
  return {type,x,y:GROUND_Y-76,w:42,h:76,vx:(type==="werewolf"?105:85),vy:0,winged:(type==="vampire"),alive:true};
}
let enemies=[makeEnemy("vampire",760),makeEnemy("werewolf",1050),makeEnemy("vampire",1380),makeEnemy("werewolf",1620)];

const SASSY_W=86, SASSY_H=112, SASSY_SPEED=240;
const sassy={active:false,started:false,hp:6,x:2140,y:GROUND_Y-SASSY_H,w:SASSY_W,h:SASSY_H,vx:0,vy:0,hitCD:0,jumpT:1.2};

const bullets=[];

/* ===== Dialog ===== */
let mode="RUN", activeTourist=null, activeStore=null;
let answerChoices=[], answerIndex=0, correctIndex=0;

const byeQuotes=[
  "‚ÄúThanks! Bye!‚Äù","‚ÄúAwesome ‚Äî appreciate it!‚Äù","‚ÄúSweet. Later!‚Äù","‚ÄúYou‚Äôre the best ‚Äî bye!‚Äù",
  "‚ÄúThanks, we‚Äôll be out of your hair.‚Äù","‚ÄúPerfect. Have a good one!‚Äù","‚ÄúYou saved us ‚Äî thanks!‚Äù"
];

const dumbQs=[
  "‚ÄúWhen do the deer turn into elk?‚Äù","‚ÄúWhere can we find Edward?‚Äù","‚ÄúDo vampires sparkle in drizzle?‚Äù",
  "‚ÄúIs the Cullen house on Airbnb?‚Äù","‚ÄúDo rangers herd whales through Peugeot Sound?‚Äù",
  "‚ÄúIs Jacob available for birthday parties?‚Äù","‚ÄúWhere is the sparkle viewing area?‚Äù"
];

const directionQs=[
  {q:"‚ÄúHow do we get to Thriftway?‚Äù",correct:"Go down Forks Ave until the big red sign.",wrong:["Follow the whales through Peugeot Sound.","Ask a vampire for Yelp directions.","Wait for Edward to appear and lead you."]},
  {q:"‚ÄúWhere‚Äôs Chinook Pharmacy?‚Äù",correct:"Stay on the main strip‚Äîkeep walking.",wrong:["Turn where the deer become elk.","Cross into La Push and howl twice.","It‚Äôs behind the sparkle treaty line."]},
  {q:"‚ÄúWhere‚Äôs the Transit Center?‚Äù",correct:"Keep to Forks Ave‚Äîwatch for the bus stop.",wrong:["Summon a werewolf rideshare.","Ask Sassy. He runs dispatch.","Go back to the 76 and request a teleport."]},
];

function renderChoices(){
  let out="";
  for(let i=0;i<answerChoices.length;i++) out += (i===answerIndex?"‚ñ∂ ":"  ")+answerChoices[i]+"\n";
  return out.trimEnd();
}
function renderChoiceBubble(q){
  showBubble(q+"\n\n"+renderChoices()+"\n\nUse LEFT/RIGHT to choose ‚Ä¢ ACTION confirms ‚Ä¢ JUMP closes");
}

/* ===== Drawing ===== */
function drawStores(){
  for(const s of stores){
    const x=sx(s.x);
    px(x,BUILD_Y,s.w,BUILD_H,s.color);
    px(x,BUILD_Y,s.w,10,"rgba(0,0,0,.25)");
    ctx.fillStyle="rgba(255,255,255,.92)";
    ctx.font="bold 14px system-ui"; ctx.textAlign="center";
    ctx.fillText(s.name, x+s.w/2, BUILD_Y+26);
    for(let i=0;i<Math.floor(s.w/70);i++) px(x+16+i*70, BUILD_Y+54, 42, 22, "rgba(255,255,255,.18)");
    const d=doorRect(s);
    px(sx(d.x), d.y, d.w, d.h, "#111827");
    px(sx(d.x)+4, d.y+14, d.w-8, 18, "rgba(255,255,255,.25)");
  }
}

function drawTom(){
  const x=sx(tom.x), y=tom.y;
  if(tom.hurt>0 && (Math.floor(tom.hurt*10)%2===0)) return;

  if(invincibleTimer>0) px(x-2,y-2,tom.w+4,tom.h+4,"rgba(255,255,255,.12)");
  px(x+Math.max(2,tom.w*0.2), y+tom.h-4, Math.max(8,tom.w*0.6), 6, "rgba(0,0,0,.25)");

  const w=tom.w,h=tom.h;
  px(x+w*0.18,y+h*0.05,w*0.64,h*0.10,"#ffcc00");
  px(x+w*0.14,y+h*0.15,w*0.72,h*0.06,"#eab308");
  px(x+w*0.26,y+h*0.21,w*0.48,h*0.18,"#f2c9a0");
  px(x+w*0.26,y+h*0.39,w*0.48,h*0.08,"#2b2b2b");
  px(x+w*0.36,y+h*0.28,w*0.08,h*0.05,"#111827");
  px(x+w*0.56,y+h*0.28,w*0.08,h*0.05,"#111827");
  px(x+w*0.22,y+h*0.46,w*0.56,h*0.26,"#b22222");
  px(x+w*0.10,y+h*0.50,w*0.12,h*0.20,"#b22222");
  px(x+w*0.78,y+h*0.50,w*0.12,h*0.20,"#b22222");
  px(x+w*0.26,y+h*0.72,w*0.22,h*0.20,"#1f2937");
  px(x+w*0.52,y+h*0.72,w*0.22,h*0.20,"#1f2937");
  px(x+w*0.22,y+h*0.92,w*0.26,h*0.08,"#111827");
  px(x+w*0.52,y+h*0.92,w*0.26,h*0.08,"#111827");

  if(tipMultiplier>1){
    px(x+w*0.18,y+h*0.03,w*0.64,h*0.05,"#111827");
    px(x+w*0.30,y+h*0.06,w*0.40,h*0.04,"#0ea5e9");
  }
}

function drawTourist(t){
  const x=sx(t.x), y=t.y;
  px(x+8,y+10,26,8, t.annoying ? "#ff7a18" : "#16a34a");
  px(x+12,y+18,18,16,"#f2c9a0");
  px(x+16,y+24,3,3,"#111827"); px(x+23,y+24,3,3,"#111827");
  px(x+10,y+34,22,24,"#64748b");
  px(x+12,y+58,9,18,"#0f172a"); px(x+21,y+58,9,18,"#0f172a");
  px(x+12,y+76,9,6,"#111827"); px(x+21,y+76,9,6,"#111827");
}

function drawWerewolf(e){
  const x=sx(e.x), y=e.y;
  px(x+6,y+14,32,38,"#6b4a2e");
  px(x+10,y+22,24,18,"#4b2f1a");
  px(x+26,y+28,12,8,"#2b1a0f");
  px(x+14,y+28,3,3,"#111827"); px(x+20,y+28,3,3,"#111827");
  px(x+10,y+52,12,18,"#111827"); px(x+22,y+52,12,18,"#111827");
}

function drawVampire(e){
  const x=sx(e.x), y=e.y;
  if(e.winged){ px(x-8,y+18,10,18,"rgba(0,0,0,.35)"); px(x+40,y+18,10,18,"rgba(0,0,0,.35)"); }
  px(x+8,y+14,28,40,"#3b1d5c");
  px(x+14,y+20,16,14,"#f3e8ff");
  px(x+17,y+24,3,3,"#111827"); px(x+24,y+24,3,3,"#111827");
  px(x+20,y+32,4,3,"#7c2d12");
  px(x+12,y+54,10,16,"#111827"); px(x+22,y+54,10,16,"#111827");
}

function drawSassy(){
  if(!sassy.active) return;
  const x=sx(sassy.x), y=sassy.y;
  px(x+6,y+8, sassy.w-12, sassy.h-16, "#3b2f2f");
  px(x+18,y+24, sassy.w-36, 28, "#2b1f1f");
  px(x+26,y+34,8,8,"#111827"); px(x+sassy.w-34,y+34,8,8,"#111827");
  ctx.fillStyle="rgba(255,255,255,.92)";
  ctx.font="bold 14px system-ui"; ctx.textAlign="left";
  ctx.fillText("SASSY HP: "+sassy.hp, x, y-8);
}

function drawBullets(){
  for(const b of bullets){
    px(sx(b.x), b.y, b.w, b.h, "#111827");
    px(sx(b.x)+2, b.y+1, b.w-4, b.h-2, "#fbbf24");
  }
}

/* ===== CLEAN HALF 2 CONTINUES BELOW (NO <script> again) ===== */
/* ===============================
   CLEAN HALF 2 of 2 ‚Äî CONTINUATION
   (NO <script> opening tag here)
================================ */

/* ---------- Collision ---------- */
function stompFromAbove(trNow, trPrev, er){
  const falling = tom.vy > 40;
  const prevBottom = trPrev.y + trPrev.h;
  const nowBottom  = trNow.y + trNow.h;
  const slack = 18;
  const cameFromAbove = prevBottom <= er.y + slack;

  const cx = trNow.x + trNow.w * 0.5;
  const inX = cx >= er.x - 18 && cx <= er.x + er.w + 18;          // larger smash window
  const inY = nowBottom >= er.y && nowBottom <= er.y + er.h * 0.98;

  return falling && cameFromAbove && inX && inY;
}

/* ---------- Dialog helpers ---------- */
function closeInteraction(){
  mode="RUN";
  activeTourist=null;
  activeStore=null;
  answerChoices=[];
  hideBubble();
  setPaused(false);
}

/* ---------- Store helpers ---------- */
function storeAtDoor(){
  const tr = rect(tom.x,tom.y,tom.w,tom.h);
  for(const s of stores){
    if(aabb(tr, doorRect(s))) return s;
  }
  return null;
}

function openStore(s){
  mode="STORE";
  setPaused(true);
  activeStore=s;

  let txt = `üè™ ${s.name}\n`;
  if(s.key==="76")      txt += `Team Jacob Hat (double tips) $15 ${tipMultiplier>1?"(OWNED)":"(BUY)"}\n`;
  if(s.key==="SHELL")   txt += "Buy beer (+6) $10\n";
  if(s.key==="CHINOOK") txt += "Common Sense Cream (invincible 5s) $12\n";
  if(s.key==="TRUE")    txt += "Ammo (+6) $9\n";
  if(s.key==="CARWASH") txt += "Wash car (+$5)\n";
  if(s.key==="TRANSIT") txt += "Bus closer ($20)\n";
  if(s.key==="SASQ")    txt += "Earrings (+15s) $12\n";
  if(s.key==="THRIFT")  txt += (sassy.active ? "Sassy blocks the door." : "Door unlocked.");
  txt += "\nACTION buys ‚Ä¢ JUMP closes";
  showBubble(txt);
}

function buyStore(){
  const s=activeStore;
  if(!s) return;

  if(s.key==="76" && tipMultiplier===1 && cash>=15){
    cash-=15;
    tipMultiplier=2;
    sfxCoin();
    showBubble("Bought: Team Jacob Hat.\nTourist tips are now DOUBLE.\n\nJUMP closes");
    return;
  }

  if(s.key==="SHELL" && cash>=10){ cash-=10; tom.beer+=6; sfxCoin(); return; }

  if(s.key==="CHINOOK" && cash>=12){
    cash-=12;
    invincibleTimer=5.0;
    sfxCoin();
    showBubble("Applied: Common Sense Cream.\nInvincible for 5 seconds.\n\nJUMP closes");
    return;
  }

  if(s.key==="TRUE" && cash>=9){ cash-=9; tom.ammo+=6; sfxCoin(); return; }

  if(s.key==="CARWASH"){ cash+=5; sfxCoin(); return; }

  if(s.key==="TRANSIT" && cash>=20 && !inBossArena){
    cash-=20;
    tom.x=1850;
    sfxCoin();
    return;
  }

  if(s.key==="SASQ" && cash>=12){ cash-=12; timeLeft+=15; sfxCoin(); return; }
}

/* ---------- Tourists ---------- */
function openTourist(t){
  if(t.tipped || t.leaving) return;

  mode="TOURIST";
  setPaused(true);
  activeTourist=t;
  t.known=true;

  if(t.annoying===null){
    t.annoying = Math.random()<0.55;
    t.throwable = t.annoying;
  }

  if(t.annoying){
    showBubble(dumbQs[(Math.random()*dumbQs.length)|0]+"\n\nACTION closes");
    return;
  }

  const dq = directionQs[(Math.random()*directionQs.length)|0];
  t.qText = dq.q;
  answerChoices = shuffle([dq.correct, ...dq.wrong]);
  correctIndex = answerChoices.indexOf(dq.correct);
  answerIndex = 0;
  renderChoiceBubble(t.qText);
}

function tipAndLeave(t){
  if(!t || t.tipped) return;                 // HARD lock: once only
  const baseTip=6;
  const tip = baseTip * tipMultiplier;
  cash += tip;

  t.tipped=true;
  t.leaving=true;
  t.vx = (t.x < tom.x ? -140 : 140);

  showBubble(byeQuotes[(Math.random()*byeQuotes.length)|0] + `\n(+ $${tip})`);
  speechTimer=1.2;
  sfxCoin();

  // End interaction cleanly so ACTION can't chain into carry/door/shoot this frame
  mode="RUN";
  answerChoices=[];
  activeTourist=null;
  setPaused(false);
}

function throwTourist(t){
  if(!t || !t.throwable) return;             // only annoying tourists
  t.sliding=true;
  t.slideV=720*tom.facing;
  tom.carry=null;
  sfxThrow();
}

/* ---------- Damage + respawn ---------- */
function respawnAt76(){
  tom.x=90;
  tom.y=GROUND_Y-tom.h;
  tom.prevX=tom.x; tom.prevY=tom.y;
  tom.vx=0; tom.vy=0;
  tom.hurt=0.9;

  inBossArena=false;
  sassy.active=false;
  sassy.started=false;
  sassy.hp=6;
}

function hitTom(dir=1){
  if(tom.hurt>0) return;
  if(invincibleTimer>0) return;

  tom.hurt=0.9;
  sfxHit();

  if(tom.big){
    setTomSize(false);                        // half-sized
    tom.vy=-540;
    tom.vx=520*dir;
  }else{
    respawnAt76();
  }
}

/* ---------- Shooting ---------- */
function spawnBullet(){
  if(tom.fireCD>0 || tom.ammo<=0) return false;
  tom.fireCD=0.18;
  tom.ammo--;

  bullets.push({
    x: tom.facing>0 ? tom.x+tom.w+2 : tom.x-10,
    y: tom.y + tom.h*0.55,
    w:10,h:4,
    vx:900*tom.facing,
    life:0.6
  });

  sfxShoot();
  return true;
}

function updateBullets(dt){
  for(const b of bullets){
    b.x += b.vx*dt;
    b.life -= dt;
    if(b.life<=0) b.dead=true;

    if(!inBossArena){
      for(const e of enemies){
        if(e.alive && aabb(rect(b.x,b.y,b.w,b.h), rect(e.x,e.y,e.w,e.h))){
          e.alive=false;
          b.dead=true;
          sfxStomp();
        }
      }
    }
  }
  for(let i=bullets.length-1;i>=0;i--) if(bullets[i].dead) bullets.splice(i,1);
}

/* ---------- Updates ---------- */
function updateTom(dt){
  tom.prevX=tom.x; tom.prevY=tom.y;

  tom.hurt = Math.max(0, tom.hurt-dt);
  tom.fireCD = Math.max(0, tom.fireCD-dt);
  invincibleTimer = Math.max(0, invincibleTimer-dt);
  speechTimer = Math.max(0, speechTimer-dt);
  if(speechTimer<=0 && mode==="RUN") hideBubble();

  tom.vx=0;
  if(input.left){ tom.vx=-260; tom.facing=-1; }
  if(input.right){ tom.vx=260; tom.facing=1; }

  tom.vy += GRAVITY*dt;
  tom.x  += tom.vx*dt;
  tom.y  += tom.vy*dt;

  if(tom.y >= GROUND_Y - tom.h){
    tom.y = GROUND_Y - tom.h;
    tom.vy = 0;
    tom.onGround = true;
  }else{
    tom.onGround = false;
  }

  tom.x = clamp(tom.x, 0, WORLD_W - tom.w);
}

function updateEnemies(dt){
  const trNow = rect(tom.x,tom.y,tom.w,tom.h);
  const trPrev= rect(tom.prevX,tom.prevY,tom.w,tom.h);

  for(const e of enemies){
    if(!e.alive) continue;

    e.vy += GRAVITY*dt;
    e.x  += e.vx*dt;
    e.y  += e.vy*dt;

    if(e.y >= GROUND_Y - e.h){
      e.y = GROUND_Y - e.h;
      e.vy = 0;
    }

    const er = rect(e.x,e.y,e.w,e.h);

    if(aabb(trNow, er)){
      if(stompFromAbove(trNow,trPrev,er)){
        if(e.type==="vampire" && e.winged){
          e.winged=false;                    // wings off
        }else{
          e.alive=false;                     // dead
        }
        tom.vy = -820;
        tom.hurt = Math.max(tom.hurt,0.12);
        sfxStomp();
      }else{
        hitTom(Math.sign(tom.x-e.x)||1);
      }
    }
  }
}

function updateTourists(dt){
  for(const t of tourists){
    if(!t.alive) continue;

    // only annoying tourists can be carried
    if(tom.carry===t){
      t.x = tom.x + (tom.facing>0?20:-20);
      t.y = tom.y + 12;
      continue;
    }

    if(t.sliding){
      t.x += t.slideV*dt;

      // sliding tourist kills enemies; both vanish
      if(!inBossArena){
        for(const e of enemies){
          if(e.alive && aabb(rect(t.x,t.y,t.w,t.h), rect(e.x,e.y,e.w,e.h))){
            e.alive=false;
            t.alive=false;
            sfxStomp();
          }
        }
      }

      if(Math.abs(t.x - tom.x) > 900) t.alive=false;
      continue;
    }

    if(t.leaving){
      t.x += t.vx*dt;
      if(t.x<-120 || t.x>WORLD_W+120) t.alive=false;
      continue;
    }

    t.x += t.vx*dt;
  }
}

/* ---------- Boss arena ---------- */
function checkBossArena(){
  if(!inBossArena && tom.x>1980){
    inBossArena=true;

    // remove all other entities
    enemies.forEach(e=>e.alive=false);
    tourists.forEach(t=>t.alive=false);
    tom.carry=null;

    // place Tom + Sassy
    tom.x=2040;
    sassy.x=2190;
    sassy.y=GROUND_Y - sassy.h;
    sassy.active=true;
    sassy.started=true;
    sassy.hp=6;
  }
}

function updateBoss(dt){
  if(!sassy.active) return;

  sassy.hitCD = Math.max(0, sassy.hitCD-dt);

  const dir = Math.sign(tom.x - sassy.x) || 1;
  sassy.vx = dir * SASSY_SPEED;

  sassy.vy += GRAVITY*dt;
  sassy.x  += sassy.vx*dt;
  sassy.y  += sassy.vy*dt;

  if(sassy.y >= GROUND_Y - sassy.h){
    sassy.y = GROUND_Y - sassy.h;
    sassy.vy = 0;
  }

  // lower jump height than Tom
  sassy.jumpT -= dt;
  if(sassy.jumpT<=0 && sassy.vy===0){
    sassy.vy = -680;
    sassy.jumpT = 1.0 + Math.random()*0.6;
  }

  const trNow = rect(tom.x,tom.y,tom.w,tom.h);
  const trPrev= rect(tom.prevX,tom.prevY,tom.w,tom.h);
  const br    = rect(sassy.x,sassy.y,sassy.w,sassy.h);

  if(aabb(trNow, br)){
    if(stompFromAbove(trNow,trPrev,br) && sassy.hitCD<=0){
      sassy.hp--;
      sassy.hitCD=0.22;
      tom.vy = -1050;                       // Tom bounces higher
      sfxStomp();

      if(sassy.hp<=0){
        sassy.active=false;
        showBubble("Sassy defeated!\nThriftway is open.\n\nGo to the door.");
        speechTimer=2.0;
      }
    }else{
      hitTom(dir);                           // grab/throw behaves like damage
    }
  }
}

/* ---------- Draw world ---------- */
function drawWorld(){
  // sky
  px(0,0,W,H,"#8fd3ff");
  // distant treeline
  px(0,100,W,80,"#a7f3d0");
  px(0,140,W,60,"#22c55e");
  // ground
  px(0,GROUND_Y,W,80,"#2f7d2a");

  drawStores();

  if(!inBossArena){
    for(const e of enemies) if(e.alive) (e.type==="werewolf"?drawWerewolf(e):drawVampire(e));
    for(const t of tourists) if(t.alive) drawTourist(t);
  }else{
    drawSassy();
  }

  drawBullets();
  drawTom();
}

/* ---------- Door + tourist priority ACTION ---------- */
function doAction(){
  // 1) drink beer if small
  if(!tom.big && tom.beer>0){
    tom.beer--;
    setTomSize(true);
    sfxCoin();
    return;
  }

  // In store: buy
  if(mode==="STORE"){ buyStore(); return; }

  // In tourist interaction:
  if(mode==="TOURIST"){
    if(activeTourist && activeTourist.annoying){
      closeInteraction();
      return;
    }
    if(answerChoices.length){
      if(answerIndex===correctIndex) tipAndLeave(activeTourist);
      else{
        showBubble("‚ÄúUgh‚Ä¶ no tip.‚Äù\n\nJUMP closes");
        speechTimer=1.1;
        // keep paused so they can read, but prevent repeat-confirm spam:
        answerChoices=[]; // clears answer state so ACTION won't keep trying to tip
      }
      return;
    }
    closeInteraction();
    return;
  }

  // 2) tourist talk/grab (talk outranks door)
  for(const t of tourists){
    if(!t.alive || t.tipped || t.leaving) continue;
    if(aabb(rect(tom.x,tom.y,tom.w,tom.h), rect(t.x,t.y,t.w,t.h))){
      if(!t.known){ openTourist(t); return; }
      if(t.throwable){ tom.carry=t; return; }
      openTourist(t); return;
    }
  }

  // 3) throw outranks door
  if(tom.carry){ throwTourist(tom.carry); return; }

  // 4) door
  const s=storeAtDoor();
  if(s){
    if(s.key==="THRIFT"){
      if(inBossArena && sassy.active){
        showBubble("Sassy blocks the door.");
        speechTimer=1.0;
        return;
      }
      if(inBossArena && !sassy.active){
        showBubble("YOU WIN!\nChicken strips + JoJos secured.\n\nReset to play again.");
        paused=true;
        won=true;
        return;
      }
    }
    openStore(s);
    return;
  }

  // 5) shoot
  spawnBullet();
}

/* ---------- Dialog nav uses same movement controls while paused ---------- */
function applyDialogInput(){
  if(!paused || mode!=="TOURIST" || !answerChoices.length) return;
  if(pressed.left){
    answerIndex = (answerIndex - 1 + answerChoices.length) % answerChoices.length;
    renderChoiceBubble(activeTourist.qText);
  }
  if(pressed.right){
    answerIndex = (answerIndex + 1) % answerChoices.length;
    renderChoiceBubble(activeTourist.qText);
  }
  if(pressed.jump){
    closeInteraction();
  }
}

/* ---------- Main loop ---------- */
let last=performance.now();
function loop(now){
  const dt=Math.min((now-last)/1000,0.05);
  last=now;

  stepPressed();

  if(running){
    if(!paused){
      timeLeft = Math.max(0, timeLeft-dt);

      // speed music near Thriftway
      const dist = Math.max(0, 2020 - tom.x);
      const t = clamp(1 - dist/1600, 0, 1);
      setTempo(165 - t*45);

      if(pressed.jump && tom.onGround){
        tom.vy = TOM_JUMP_VY;
        sfxJump();
      }

      updateTom(dt);
      checkBossArena();

      camX = clamp(tom.x - 170, 0, WORLD_W - W);

      updateBullets(dt);
      if(!inBossArena) updateEnemies(dt);
      updateTourists(dt);
      if(inBossArena) updateBoss(dt);

      if(timeLeft<=0){
        paused=true;
        showBubble("Time‚Äôs up!");
        speechTimer=2.0;
      }
    }else{
      applyDialogInput();
    }

    if(pressed.action) doAction();
  }

  hudBeer.textContent = tom.beer;
  hudCash.textContent = cash;
  hudAmmo.textContent = tom.ammo;
  hudTime.textContent = timeLeft|0;
  hudZone.textContent = inBossArena ? "THRIFTWAY LOT" : "FORKS AVE";

  drawWorld();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ---------- Start state ---------- */
function startAt76(){
  setTomSize(true);
  tom.x=90; tom.y=GROUND_Y-tom.h;
  tom.prevX=tom.x; tom.prevY=tom.y;
  tom.vx=0; tom.vy=0; tom.hurt=0;
  tom.beer=6; tom.ammo=0; tom.carry=null;

  timeLeft=160;
  cash=0;
  tipMultiplier=1;
  invincibleTimer=0;
  speechTimer=0;

  inBossArena=false;
  sassy.active=false; sassy.started=false; sassy.hp=6;
}
startAt76();
</script>

</body>
</html>
