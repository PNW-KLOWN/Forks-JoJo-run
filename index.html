<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Forks Ave ‚Äî JoJos Run</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<style>
  *{-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#071021;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}
  #wrap{width:100vw;height:100vh;display:flex;align-items:center;justify-content:center}
  canvas{width:100vw;max-width:520px;height:100vh;max-height:960px;background:#8fd3ff;border-radius:14px;image-rendering:pixelated;touch-action:none}
  #hud{position:fixed;top:0;left:0;right:0;padding:8px 10px;background:rgba(0,0,0,.78);color:#fff;display:flex;justify-content:space-between;align-items:center;z-index:50;font-size:14px;box-sizing:border-box;pointer-events:auto}
  #hud .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  #hud button{border:none;border-radius:12px;padding:8px 10px;background:#1f2937;color:#fff;font-weight:900}
  #controls{position:fixed;left:0;right:0;bottom:10px;display:flex;gap:8px;padding:0 10px;z-index:50;box-sizing:border-box;pointer-events:auto}
  .ctrl{flex:1;border:none;border-radius:16px;padding:14px 10px;font-size:16px;font-weight:950;color:#fff;background:#111827;touch-action:none}
  .ctrl.jump{background:#16a34a}
  .ctrl.action{background:#2563eb}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:9999;pointer-events:auto}
  .panel{width:92%;max-width:560px;background:#0f1e35;color:#fff;border-radius:18px;padding:18px;box-sizing:border-box;pointer-events:auto}
  .panel *{pointer-events:auto}
  .panel h1{margin:0 0 10px;font-size:26px}
  .panel p{margin:8px 0;line-height:1.35}
  .panel .btn{width:100%;margin-top:12px;border:none;border-radius:16px;padding:14px;font-size:18px;font-weight:950;background:#2563eb;color:#fff}
  .panel .btn.secondary{background:#1f2937}
  #bubble{position:fixed;left:50%;transform:translateX(-50%);bottom:118px;width:min(520px,92vw);background:#fff;color:#0b1220;border-radius:16px;padding:12px 12px;box-shadow:0 8px 24px rgba(0,0,0,.35);z-index:60;display:none;white-space:pre-line;box-sizing:border-box;pointer-events:none}
</style>
</head>

<body>
<div id="hud">
  <div class="row">
    <span>üç∫ <b id="hudBeer">6</b></span>
    <span>üíµ $<b id="hudCash">0</b></span>
    <span>üî´ <b id="hudAmmo">0</b></span>
    <span>‚è± <b id="hudTime">160</b>s</span>
    <span>üìç <b id="hudZone">FORKS AVE</b></span>
  </div>
  <div class="row">
    <button id="btnReset" type="button">Reset</button>
  </div>
</div>

<div id="wrap"><canvas id="game" width="360" height="640"></canvas></div>

<div id="controls">
  <button class="ctrl" id="btnLeft"  type="button">‚¨Ö</button>
  <button class="ctrl jump" id="btnJump" type="button">JUMP</button>
  <button class="ctrl" id="btnRight" type="button">‚û°</button>
  <button class="ctrl action" id="btnAction" type="button">ACTION</button>
</div>

<div id="bubble"></div>

<div class="overlay" id="startOverlay">
  <div class="panel">
    <h1>Forks Ave ‚Äî JoJos Run</h1>
    <p><b>Story:</b> The crew bus just dropped Tom off at the 76. He‚Äôs a logger on a mission: reach Thriftway‚Äôs hot case for chicken strips and JoJos before the tourists buy them all up.</p>
    <p><b>Tourists:</b> Talk first. Some ask directions and tip if you answer right (and then they leave). Some ask painfully stupid Twilight questions‚Ä¶ and those are the ones you can throw.</p>
    <p><b>Enemies:</b> Vampires (winged) & werewolves. Jump on them like a classic platformer.</p>
    <p><b>Beer:</b> Big hit ‚Üí small. Small hit ‚Üí back to 76. (Invincibility frames prevent instant double-hit.)</p>
    <button class="btn" id="startBtn" type="button">START</button>
    <button class="btn secondary" id="howBtn" type="button">CONTROLS / GOAL</button>
  </div>
</div>

<div class="overlay" id="howOverlay" style="display:none;">
  <div class="panel">
    <h1>Controls / Goal</h1>
    <p><b>Mobile:</b> Use on-screen buttons.</p>
    <p><b>Keyboard:</b> A/D or ‚Üê/‚Üí move, W/‚Üë jump, Space/Enter = ACTION, Esc closes dialogs.</p>
    <p><b>One ACTION button:</b> Talk ‚Ä¢ Grab ‚Ä¢ Throw ‚Ä¢ Shoot ‚Ä¢ Drink beer ‚Ä¢ Use store door.</p>
    <p><b>Goal:</b> Reach Thriftway, defeat <b>Sassy the Sasquatch</b> in the parking lot, then enter the door to win.</p>
    <button class="btn" id="backBtn" type="button">BACK</button>
  </div>
</div>

<script>
document.addEventListener("contextmenu", e=>e.preventDefault());
document.addEventListener("selectstart", e=>e.preventDefault());

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const hudBeer = document.getElementById("hudBeer");
const hudCash = document.getElementById("hudCash");
const hudAmmo = document.getElementById("hudAmmo");
const hudTime = document.getElementById("hudTime");
const hudZone = document.getElementById("hudZone");

const bubble = document.getElementById("bubble");
function showBubble(text){ bubble.style.display="block"; bubble.textContent=text; }
function hideBubble(){ bubble.style.display="none"; bubble.textContent=""; }

let running=false, paused=false, won=false;
function setPaused(v){ paused=v; }

/* ---------- Audio ---------- */
let audioCtx=null, musicTimer=null, tempoMs=165, noteIndex=0, audioUnlocked=false;
const melody=[262,294,330,392,440,392,330,294,262,330,392,523,587,523,392,330,294,330,370,440,494,440,370,330,262,294,330,392,440,523,494,392];
function ensureAudio(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==="suspended") audioCtx.resume(); }
function playTone(freq,dur=0.10,vol=0.05,type="square"){
  if(!audioCtx) return;
  const osc=audioCtx.createOscillator(), gain=audioCtx.createGain();
  osc.type=type; osc.frequency.value=freq;
  gain.gain.value=vol;
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime+dur);
}
function startMusic(){
  if(!audioUnlocked || musicTimer) return;
  musicTimer=setInterval(()=>{ ensureAudio(); playTone(melody[noteIndex++%melody.length],0.12,0.035,"square"); }, tempoMs);
}
function setTempo(ms){
  ms=Math.max(110,Math.min(220,ms|0));
  if(ms===tempoMs) return;
  tempoMs=ms;
  if(musicTimer){ clearInterval(musicTimer); musicTimer=null; }
  startMusic();
}
function unlockAudio(){ if(audioUnlocked) return; audioUnlocked=true; ensureAudio(); startMusic(); }
function sfxJump(){ playTone(740,0.07,0.06,"square"); }
function sfxStomp(){ playTone(220,0.08,0.07,"square"); }
function sfxHit(){ playTone(160,0.10,0.07,"sawtooth"); }
function sfxCoin(){ playTone(880,0.06,0.05,"square"); playTone(1174,0.06,0.04,"square"); }
function sfxThrow(){ playTone(330,0.06,0.06,"square"); }
function sfxShoot(){ playTone(980,0.04,0.05,"square"); playTone(490,0.06,0.04,"square"); }

/* ---------- Input ---------- */
const input={left:false,right:false,jump:false,action:false};
function bindHold(el,key){
  el.addEventListener("pointerdown",(e)=>{e.preventDefault(); input[key]=true; unlockAudio();},{passive:false});
  el.addEventListener("pointerup",(e)=>{e.preventDefault(); input[key]=false;},{passive:false});
  el.addEventListener("pointerleave",()=>{input[key]=false;});
  el.addEventListener("pointercancel",()=>{input[key]=false;});
}
bindHold(document.getElementById("btnLeft"),"left");
bindHold(document.getElementById("btnRight"),"right");
bindHold(document.getElementById("btnJump"),"jump");
bindHold(document.getElementById("btnAction"),"action");

window.addEventListener("keydown",(e)=>{
  if(e.repeat) return;
  unlockAudio();
  const k=e.key;
  if(k==="ArrowLeft"||k==="a") input.left=true;
  if(k==="ArrowRight"||k==="d") input.right=true;
  if(k==="ArrowUp"||k==="w") input.jump=true;
  if(k===" "||k==="Enter") input.action=true;
  if(k==="Escape"){ if(paused) closeInteraction(); }
});
window.addEventListener("keyup",(e)=>{
  const k=e.key;
  if(k==="ArrowLeft"||k==="a") input.left=false;
  if(k==="ArrowRight"||k==="d") input.right=false;
  if(k==="ArrowUp"||k==="w") input.jump=false;
  if(k===" "||k==="Enter") input.action=false;
});

/* ---------- UI ---------- */
window.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("btnReset").addEventListener("click", ()=>location.reload());
  document.getElementById("startBtn").addEventListener("click", ()=>{
    document.getElementById("startOverlay").style.display="none";
    running=true;
    unlockAudio();
  });
  document.getElementById("howBtn").addEventListener("click", ()=>{
    document.getElementById("howOverlay").style.display="flex";
  });
  document.getElementById("backBtn").addEventListener("click", ()=>{
    document.getElementById("howOverlay").style.display="none";
  });
});

/* ---------- Helpers ---------- */
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function rect(x,y,w,h){ return {x,y,w,h}; }
function aabb(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }
function px(x,y,w,h,c){ ctx.fillStyle=c; ctx.fillRect(x,y,w,h); }
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

/* ---------- World/state ---------- */
const W=canvas.width, H=canvas.height;
let WORLD_W=2600;
const GROUND_Y=560, GRAVITY=2200;
const BUILD_Y=GROUND_Y-210, BUILD_H=190;

let timeLeft=160, cash=0, camX=0, inBossArena=false;
function sx(worldX){ return worldX - camX; }

/* ---------- Stores ---------- */
const stores=[
  { key:"76",     name:"Evergreen 76",   x:  40, w:220, color:"#9b1c1c", door:{dx:95,w:34} },
  { key:"SHELL",  name:"Shell",          x: 330, w:220, color:"#d4a300", door:{dx:92,w:34} },
  { key:"CHINOOK",name:"Chinook Rx",     x: 610, w:240, color:"#0f766e", door:{dx:104,w:34} },
  { key:"TRUE",   name:"True Value",     x: 910, w:240, color:"#5b21b6", door:{dx:104,w:34} },
  { key:"TRANSIT",name:"Transit",        x:1220, w:220, color:"#334155", door:{dx:92,w:34} },
  { key:"CARWASH",name:"Car Wash",       x:1470, w:210, color:"#1d4ed8", door:{dx:88,w:34} },
  { key:"SASQ",   name:"Sasquatch Shop", x:1730, w:240, color:"#6d4c41", door:{dx:104,w:34} },
  { key:"THRIFT", name:"Thriftway",      x:2020, w:360, color:"#b50000", door:{dx:160,w:48} },
];
WORLD_W = stores.reduce((m,s)=>Math.max(m,s.x+s.w),0)+260;
function doorRect(s){ return rect(s.x+s.door.dx, GROUND_Y-84, s.door.w, 84); }

/* ---------- Player ---------- */
const TOM_BIG  = { w:44, h:96 };
const TOM_SMALL= { w:38, h:72 };
const TOM_JUMP_VY = -1040;

const tom={
  x:90,y:GROUND_Y-TOM_BIG.h,
  w:TOM_BIG.w,h:TOM_BIG.h,
  vx:0,vy:0,onGround:false,
  big:true,beer:6,ammo:0,
  facing:1,carry:null,
  hurt:0, fireCD:0
};

function setTomSize(isBig){
  const footY = tom.y + tom.h;
  tom.big=isBig;
  if(isBig){ tom.w=TOM_BIG.w; tom.h=TOM_BIG.h; }
  else{ tom.w=TOM_SMALL.w; tom.h=TOM_SMALL.h; }
  tom.y = footY - tom.h;
}

/* ---------- NPC / enemies ---------- */
function makeTourist(x){
  return {
    x,y:GROUND_Y-82,w:38,h:82,
    vx:(Math.random()<0.5?-40:40),
    alive:true,
    known:false,
    annoying:null,
    smart:false,
    throwable:false,
    sliding:false,slideV:0,
    // NEW: good tourists leave after interaction (tip once)
    leaving:false,
    tipped:false
  };
}
let tourists=[makeTourist(420),makeTourist(680),makeTourist(980),makeTourist(1320),makeTourist(1600)];

function makeEnemy(type,x){
  return {type,x,y:GROUND_Y-76,w:42,h:76,vx:(type==="werewolf"?95:75),vy:0,winged:(type==="vampire"),alive:true};
}
let enemies=[makeEnemy("vampire",760),makeEnemy("werewolf",1050),makeEnemy("vampire",1380),makeEnemy("werewolf",1620)];

const elk={active:false,x:0,y:GROUND_Y-54,w:90,h:48,vx:-560};

const SASSY_W=86, SASSY_H=112, SASSY_JUMP_VY=-760, SASSY_SPEED=260;
const sassy={active:false,started:false,hp:6,x:2140,y:GROUND_Y-SASSY_H,w:SASSY_W,h:SASSY_H,vx:0,vy:0,onGround:false,jumpT:1.1};

const hazards=[{x:520,w:52,type:"pothole"},{x:1120,w:70,type:"puddle"},{x:1460,w:60,type:"cart"}];
let hazardCooldown=0;

/* ---------- Bullets ---------- */
const bullets=[];
function spawnBullet(){
  if(tom.fireCD>0 || tom.ammo<=0) return false;
  tom.ammo -= 1;
  tom.fireCD = 0.18;
  const bx = tom.facing>0 ? (tom.x + tom.w + 2) : (tom.x - 10);
  bullets.push({x:bx, y:tom.y + Math.min(34, tom.h-18), w:10, h:4, vx: tom.facing * 900, life:0.65});
  sfxShoot();
  return true;
}

/* ---------- Dialog state ---------- */
let runningMode="RUN";
let mode="RUN", activeTourist=null, activeStore=null;
let answerChoices=[], answerIndex=0, correctIndex=0;

const dumbQs=[
  "‚ÄúWhen do the deer turn into elk?‚Äù",
  "‚ÄúWhere can we find Edward?‚Äù",
  "‚ÄúDo vampires sparkle in the shade or only in drizzle?‚Äù",
  "‚ÄúIs the Cullen house on Airbnb?‚Äù",
  "‚ÄúDo park rangers herd whales through the Peugeot sound?‚Äù",
  "‚ÄúIs Jacob available for birthday parties?‚Äù",
  "‚ÄúWhere is the vampire sparkle viewing area?‚Äù"
];
const directionQs=[
  {q:"‚ÄúHow do we get to Thriftway?‚Äù",correct:"Go down Forks Ave until the big red sign.",wrong:["Follow the whales through Peugeot Sound.","Ask a vampire for Yelp directions.","Wait for Edward to appear and lead you."]},
  {q:"‚ÄúWhere‚Äôs Chinook Pharmacy?‚Äù",correct:"Stay on the main strip‚Äîkeep walking.",wrong:["Turn where the deer become elk.","Cross into La Push and howl twice.","It‚Äôs behind the sparkle treaty line."]},
  {q:"‚ÄúWhere‚Äôs the Transit Center?‚Äù",correct:"Keep to Forks Ave‚Äîwatch for the bus stop.",wrong:["Summon a werewolf rideshare.","Ask Sassy. He runs dispatch.","Go back to the 76 and request a teleport."]},
];
function renderChoices(){
  let out="";
  for(let i=0;i<answerChoices.length;i++) out += (i===answerIndex?"‚ñ∂ ":"  ")+answerChoices[i]+"\n";
  return out.trimEnd();
}

/* ---------- Drawing ---------- */
function drawStores(){
  for(const s of stores){
    const x=sx(s.x);
    px(x, BUILD_Y, s.w, BUILD_H, s.color);
    px(x, BUILD_Y, s.w, 10, "rgba(0,0,0,.25)");
    ctx.fillStyle="rgba(255,255,255,.92)";
    ctx.font="bold 14px system-ui";
    ctx.textAlign="center";
    ctx.fillText(s.name, x+s.w/2, BUILD_Y+26);
    for(let i=0;i<Math.floor(s.w/70);i++) px(x+16+i*70, BUILD_Y+54, 42, 22, "rgba(255,255,255,.18)");
    const d=doorRect(s);
    px(sx(d.x), d.y, d.w, d.h, "#111827");
    px(sx(d.x)+4, d.y+14, d.w-8, 18, "rgba(255,255,255,.25)");
  }
}

function drawTom(){
  const x=sx(tom.x), y=tom.y;
  if(tom.hurt>0 && (Math.floor(tom.hurt*10)%2===0)) return;
  px(x+8, y+tom.h-4, 28, 6, "rgba(0,0,0,.25)");
  px(x+8, y+6, 28, 10, "#ffcc00");
  px(x+6, y+14, 32, 6, "#eab308");
  px(x+12, y+20, 20, 18, "#f2c9a0");
  px(x+12, y+34, 20, 8, "#2b2b2b");
  px(x+16, y+26, 4, 4, "#111827");
  px(x+24, y+26, 4, 4, "#111827");
  px(x+10, y+40, 24, 28, "#b22222");
  px(x+10, y+46, 24, 4, "#1e3a8a");
  px(x+10, y+54, 24, 4, "#1e3a8a");
  px(x+10, y+62, 24, 3, "#1e3a8a");
  px(x+4,  y+44, 6, 22, "#b22222");
  px(x+34, y+44, 6, 22, "#b22222");
  px(x+4,  y+66, 6, 6, "#f2c9a0");
  px(x+34, y+66, 6, 6, "#f2c9a0");
  px(x+12, y+68, 10, 18, "#1f2937");
  px(x+22, y+68, 10, 18, "#1f2937");
  px(x+10, y+86, 12, 8, "#111827");
  px(x+22, y+86, 12, 8, "#111827");
  px(x+12, y+94, 8, 2, "#9ca3af");
  px(x+24, y+94, 8, 2, "#9ca3af");
  if(!tom.big) px(x+10, y+40, 24, 6, "rgba(255,255,255,.18)");
}

function drawTourist(t){
  const x=sx(t.x), y=t.y;
  px(x+8,y+10,26,8, t.annoying ? "#ff7a18" : "#16a34a");
  px(x+12,y+18,18,16,"#f2c9a0");
  px(x+16,y+24,3,3,"#111827");
  px(x+23,y+24,3,3,"#111827");
  px(x+10,y+34,22,24,"#64748b");
  px(x+14,y+40,14,8,"#111827");
  px(x+4,y+40,8,12,"#94a3b8");
  px(x+12,y+58,9,18,"#0f172a");
  px(x+21,y+58,9,18,"#0f172a");
  px(x+12,y+76,9,6,"#111827");
  px(x+21,y+76,9,6,"#111827");
}

function drawWerewolf(e){
  const x=sx(e.x), y=e.y;
  px(x+6,y+14,32,38,"#6b4a2e");
  px(x+10,y+22,24,18,"#4b2f1a");
  px(x+26,y+28,12,8,"#2b1a0f");
  px(x+14,y+28,3,3,"#111827");
  px(x+20,y+28,3,3,"#111827");
  px(x+10,y+52,12,18,"#111827");
  px(x+22,y+52,12,18,"#111827");
  px(x+8,y+70,14,6,"#111827");
  px(x+22,y+70,14,6,"#111827");
}

function drawVampire(e){
  const x=sx(e.x), y=e.y;
  if(e.winged){
    px(x-8,y+18,10,18,"rgba(0,0,0,.35)");
    px(x+40,y+18,10,18,"rgba(0,0,0,.35)");
  }
  px(x+8,y+14,28,40,"#3b1d5c");
  px(x+14,y+20,16,14,"#f3e8ff");
  px(x+17,y+24,3,3,"#111827");
  px(x+24,y+24,3,3,"#111827");
  px(x+20,y+32,4,3,"#7c2d12");
  px(x+12,y+54,10,16,"#111827");
  px(x+22,y+54,10,16,"#111827");
  px(x+10,y+70,12,6,"#111827");
  px(x+22,y+70,12,6,"#111827");
}

function drawElk(){
  if(!elk.active) return;
  const x=sx(elk.x), y=elk.y;
  px(x, y, elk.w, elk.h, "#c68642");
  px(x+14, y+14, 20, 6, "rgba(0,0,0,.22)");
  px(x+60, y+6, 10, 10, "#8b5a2b");
}

function drawSassy(){
  if(!sassy.active) return;
  const x=sx(sassy.x), y=sassy.y;
  px(x+6,y+8, sassy.w-12, sassy.h-16, "#3b2f2f");
  px(x+18,y+24, sassy.w-36, 28, "#2b1f1f");
  px(x+26,y+34,8,8,"#111827");
  px(x+sassy.w-34,y+34,8,8,"#111827");
  px(x+24,y+56, sassy.w-48, 8, "#111827");
  px(x-8, y+34, 18, 42, "#3b2f2f");
  px(x+sassy.w-10, y+34, 18, 42, "#3b2f2f");
  ctx.fillStyle="rgba(255,255,255,.92)";
  ctx.font="bold 14px system-ui";
  ctx.textAlign="left";
  ctx.fillText("SASSY HP: "+sassy.hp, x, y-8);
}

function drawBullets(){
  for(const b of bullets){
    px(sx(b.x), b.y, b.w, b.h, "#111827");
    px(sx(b.x)+2, b.y+1, b.w-4, b.h-2, "#fbbf24");
  }
}

/* ===== HALF 2 continues from here ===== */
</script>
<script>
/* =========================================================
   REPLACE-ALL BUILD ‚Äî HALF 2/2  (UPDATED: SASSY STOMP WORKS)
========================================================= */

function hazardRect(hz){ return rect(hz.x, GROUND_Y-18, hz.w, 18); }

function storeAtDoor(){
  const tr = rect(tom.x,tom.y,tom.w,tom.h);
  for(const s of stores){
    if(aabb(tr, doorRect(s))) return s;
  }
  return null;
}

/* ‚úÖ More forgiving stomp test (works on Sassy too) */
function isStomp(tr, er){
  // must be descending at least a little
  if(tom.vy <= 20) return false;

  const feet = tr.y + tr.h;
  const centerX = tr.x + tr.w*0.5;

  // widened horizontal forgiveness
  const inX = centerX >= (er.x - 10) && centerX <= (er.x + er.w + 10);

  // head zone is larger to feel like Mario
  const headBand = er.y + er.h * 0.62;

  // approximate previous feet position (helps detect "came from above")
  const prevFeet = feet - tom.vy * (1/60);

  const cameFromAbove = prevFeet <= (headBand + 12);
  const inVerticalBand = feet >= (er.y + 6) && feet <= (er.y + er.h * 0.80);

  return inX && cameFromAbove && inVerticalBand;
}

function closeInteraction(){
  mode="RUN";
  activeTourist=null;
  activeStore=null;
  answerChoices=[];
  hideBubble();
  setPaused(false);
}

/* ---------- Stores ---------- */
function openStore(s){
  mode="STORE";
  setPaused(true);
  activeStore=s;

  let text=`üè™ ${s.name}\n`;
  if(s.key==="SHELL")   text += "1) Buy beer case (+6) ‚Äî $10\n";
  if(s.key==="CHINOOK") text += "1) Blister cream ‚Äî $8\n";
  if(s.key==="TRUE")    text += "1) Ammo (+6) ‚Äî $9\n";
  if(s.key==="SASQ")    text += "1) Earrings (wife) ‚Äî $12 (+15s)\n";
  if(s.key==="CARWASH") text += "1) Wash car ‚Äî Earn $5\n";
  if(s.key==="TRANSIT") text += "1) Bus closer to Thriftway ‚Äî $20\n";
  if(s.key==="THRIFT"){
    if(!inBossArena) text += "Parking lot ahead‚Ä¶\n";
    else text += (sassy.active ? "Door locked until Sassy is defeated.\n" : "Door unlocked.\n");
  }
  if(s.key==="76") text += "The crew bus already left. Typical.\n";

  text += "\nACTION buys option 1 ‚Ä¢ JUMP closes";
  showBubble(text);
}

function buyStore(){
  const s=activeStore;
  if(!s) return;

  if(s.key==="SHELL"){
    if(cash>=10){ cash-=10; tom.beer+=6; sfxCoin(); }
  }else if(s.key==="CHINOOK"){
    if(cash>=8){ cash-=8; sfxCoin(); }
  }else if(s.key==="TRUE"){
    if(cash>=9){ cash-=9; tom.ammo+=6; sfxCoin(); }
  }else if(s.key==="SASQ"){
    if(cash>=12){ cash-=12; timeLeft+=15; sfxCoin(); }
  }else if(s.key==="CARWASH"){
    cash+=5; sfxCoin();
  }else if(s.key==="TRANSIT"){
    if(cash>=20 && !inBossArena){
      cash-=20;
      tom.x = 1880;
      tom.y = GROUND_Y - tom.h;
      tom.vx=0; tom.vy=0;
      sfxCoin();
    }
  }
}

/* ---------- Tourists ---------- */
function renderChoiceBubble(question){
  showBubble(
    question + "\n\n" +
    renderChoices() +
    "\n\nUse LEFT/RIGHT (or A/D) to choose ‚Ä¢ ACTION confirms ‚Ä¢ JUMP closes"
  );
}

function openTourist(t){
  mode="TOURIST";
  setPaused(true);
  activeTourist=t;
  t.known=true;

  if(t.annoying===null){
    t.annoying = Math.random() < 0.55;
    t.smart = !t.annoying;
    t.throwable = t.annoying;
  }

  if(t.annoying){
    const q = dumbQs[(Math.random()*dumbQs.length)|0];
    showBubble(q + "\n\nACTION closes");
    return;
  }

  const dq = directionQs[(Math.random()*directionQs.length)|0];
  const choices = shuffle([dq.correct, ...dq.wrong]);
  answerChoices = choices;
  answerIndex = 0;
  correctIndex = choices.indexOf(dq.correct);

  renderChoiceBubble(dq.q);
}

function answerNav(dir){
  if(!paused || mode!=="TOURIST" || answerChoices.length===0) return;
  answerIndex = (answerIndex + dir + answerChoices.length) % answerChoices.length;
  const q = bubble.textContent.split("\n\n")[0];
  renderChoiceBubble(q);
}

/* ---------- Throwing ---------- */
function throwTourist(t){
  t.sliding=true;
  t.slideV=720*tom.facing;
  tom.carry=null;
  sfxThrow();
}

/* ---------- Respawn / damage (NO time reset) ---------- */
function respawnAt76(){
  tom.x=90;
  tom.y=GROUND_Y-tom.h;
  tom.vx=0; tom.vy=0;
  tom.onGround=false;
  tom.facing=1;
  tom.hurt=0.9;

  inBossArena=false;

  sassy.active=false;
  sassy.started=false;
  sassy.hp=6;
  sassy.hitCD=0;

  enemies=[
    makeEnemy("vampire",760),
    makeEnemy("werewolf",1050),
    makeEnemy("vampire",1380),
    makeEnemy("werewolf",1620),
  ];
  tourists=[
    makeTourist(420),
    makeTourist(680),
    makeTourist(980),
    makeTourist(1320),
    makeTourist(1600),
  ];
  elk.active=false;
  hazardCooldown=0;
  hudZone.textContent="FORKS AVE";
}

function hitTom(knockDir=0){
  if(tom.hurt>0) return;
  tom.hurt=0.9;
  sfxHit();

  if(tom.big){
    setTomSize(false);
    tom.vy=-540;
    tom.vx=520*(knockDir || -tom.facing);
  }else{
    respawnAt76();
  }
}

/* ---------- Bullets ---------- */
function updateBullets(dt){
  for(const b of bullets){
    b.x += b.vx*dt;
    b.life -= dt;
    if(b.life<=0) b.dead=true;

    if(!inBossArena){
      const br=rect(b.x,b.y,b.w,b.h);
      for(const e of enemies){
        if(!e.alive) continue;
        if(aabb(br, rect(e.x,e.y,e.w,e.h))){
          e.alive=false;
          b.dead=true;
          sfxStomp();
          break;
        }
      }
    }
  }
  for(let i=bullets.length-1;i>=0;i--) if(bullets[i].dead) bullets.splice(i,1);
}

/* ---------- Updates ---------- */
function updateTom(dt){
  tom.hurt = Math.max(0, tom.hurt - dt);
  tom.fireCD = Math.max(0, tom.fireCD - dt);

  const speed=260;
  tom.vx=0;
  if(input.left){ tom.vx=-speed; tom.facing=-1; }
  if(input.right){ tom.vx= speed; tom.facing= 1; }

  tom.vy += GRAVITY*dt;
  tom.x  += tom.vx*dt;
  tom.y  += tom.vy*dt;

  if(tom.y >= GROUND_Y - tom.h){
    tom.y = GROUND_Y - tom.h;
    tom.vy = 0;
    tom.onGround = true;
  }else{
    tom.onGround = false;
  }

  tom.x = clamp(tom.x, 0, WORLD_W - tom.w);
}

function updateEnemies(dt){
  for(const e of enemies){
    if(!e.alive) continue;

    if(e.type==="vampire" && e.winged && Math.random()<0.012){
      e.vy=-760;
    }

    e.vy += GRAVITY*dt;
    e.x  += e.vx*dt;
    e.y  += e.vy*dt;

    if(e.x < 640)  e.vx = Math.abs(e.vx);
    if(e.x > 1720) e.vx = -Math.abs(e.vx);

    if(e.y >= GROUND_Y - e.h){
      e.y = GROUND_Y - e.h;
      e.vy = 0;
    }

    const tr=rect(tom.x,tom.y,tom.w,tom.h);
    const er=rect(e.x,e.y,e.w,e.h);

    if(aabb(tr,er)){
      if(isStomp(tr,er)){
        if(e.type==="vampire" && e.winged){
          e.winged=false;
        }else{
          e.alive=false;
        }
        tom.vy=-720;
        tom.hurt=Math.max(tom.hurt, 0.10); // prevents instant side-hit mid-bounce
        sfxStomp();
      }else{
        if(tom.hurt<=0) hitTom(Math.sign(tom.x - e.x) || 1);
      }
    }
  }
}

function updateTourists(dt){
  for(const t of tourists){
    if(!t.alive) continue;

    if(tom.carry===t){
      t.x = tom.x + (tom.facing>0 ? 20 : -20);
      t.y = tom.y + 12;
      continue;
    }

    if(t.sliding){
      t.x += t.slideV*dt;
      t.y = GROUND_Y - t.h;

      const tr=rect(t.x,t.y,t.w,t.h);
      for(const e of enemies){
        if(!e.alive) continue;
        if(aabb(tr, rect(e.x,e.y,e.w,e.h))){
          e.alive=false;
          t.alive=false;
          sfxStomp();
          break;
        }
      }
      if(Math.abs(t.x - tom.x) > 900) t.alive=false;
      continue;
    }

    t.x += t.vx*dt;
    if(Math.random()<0.01) t.vx *= -1;
    t.x = clamp(t.x, 220, 1850);
  }
}

function updateHazards(dt){
  hazardCooldown = Math.max(0, hazardCooldown - dt);
  if(hazardCooldown>0) return;

  const tr=rect(tom.x,tom.y,tom.w,tom.h);
  for(const hz of hazards){
    const hr=hazardRect(hz);
    if(aabb(tr,hr) && tom.onGround){
      hazardCooldown=0.95;
      timeLeft = Math.max(0, timeLeft - 4);
      if(hz.type==="cart") hitTom(tom.facing);
      return;
    }
  }
}

/* ---------- Elk ---------- */
function maybeSpawnElk(){
  if(inBossArena || elk.active) return;
  if(tom.x>1150 && Math.random()<0.012){
    elk.active=true;
    elk.x = tom.x + 520;
  }
}
function updateElk(dt){
  if(!elk.active) return;
  elk.x += elk.vx*dt;
  if(elk.x < tom.x - 900) elk.active=false;

  const tr=rect(tom.x,tom.y,tom.w,tom.h);
  const er=rect(elk.x,elk.y,elk.w,elk.h);
  if(aabb(tr,er)){
    if(isStomp(tr,er)){
      elk.active=false;
      tom.vy=-760;
      tom.hurt=Math.max(tom.hurt, 0.10);
      sfxStomp();
    }else{
      if(tom.hurt<=0) hitTom(Math.sign(tom.x - elk.x) || 1);
      elk.active=false;
    }
  }
}

/* ---------- Boss arena ---------- */
function checkBossArenaEntry(){
  if(inBossArena) return;
  if(tom.x > 1950){
    inBossArena=true;
    hudZone.textContent="THRIFTWAY LOT";
    enemies.forEach(e=>e.alive=false);
    tourists.forEach(t=>t.alive=false);
  }
}

function startBoss(){
  sassy.active=true;
  sassy.started=true;
  sassy.hp=6;
  sassy.hitCD=0;          // ‚úÖ stomp cooldown
  sassy.x=2140;
  sassy.y=GROUND_Y-sassy.h;
  sassy.vx=-SASSY_SPEED;
  sassy.vy=0;
  sassy.onGround=true;
  sassy.jumpT=1.05;
}

function updateBoss(dt){
  if(!sassy.active) return;

  // cooldown between stomps so you can bounce and land again cleanly
  sassy.hitCD = Math.max(0, (sassy.hitCD||0) - dt);

  const dir = Math.sign(tom.x - sassy.x) || 1;
  sassy.vx = dir * SASSY_SPEED;

  sassy.jumpT -= dt;
  if(sassy.jumpT<=0 && sassy.onGround){
    sassy.vy = SASSY_JUMP_VY;
    sassy.onGround=false;
    sassy.jumpT = 0.9 + Math.random()*0.7;
  }

  sassy.vy += GRAVITY*dt;
  sassy.x  += sassy.vx*dt;
  sassy.y  += sassy.vy*dt;

  sassy.x = clamp(sassy.x, 1960, 2360);

  if(sassy.y >= GROUND_Y - sassy.h){
    sassy.y = GROUND_Y - sassy.h;
    sassy.vy = 0;
    sassy.onGround=true;
  }

  const tr=rect(tom.x,tom.y,tom.w,tom.h);
  const br=rect(sassy.x,sassy.y,sassy.w,sassy.h);

  if(aabb(tr,br)){
    // ‚úÖ STOMP ALWAYS CHECKED FIRST
    if(isStomp(tr,br) && sassy.hitCD<=0){
      sassy.hp -= 1;
      sassy.hitCD = 0.35;       // short window before next damage
      tom.vy = -980;            // bounce up so you can chain stomps
      tom.hurt = Math.max(tom.hurt, 0.18); // prevents instant side-hit on the bounce
      sfxStomp();
      if(sassy.hp<=0) sassy.active=false;
    }else{
      // body-hit only if Tom isn't in i-frames
      if(tom.hurt<=0) hitTom(dir);
      tom.x = clamp(tom.x - dir*70, 1960, 2360);
    }
  }
}

/* ---------- Draw hazards / world ---------- */
function drawHazards(){
  for(const hz of hazards){
    const x = sx(hz.x);
    if(hz.type==="pothole"){
      px(x, GROUND_Y-16, hz.w, 16, "#1f2937");
      px(x+6, GROUND_Y-12, hz.w-12, 8, "rgba(255,255,255,.10)");
    }else if(hz.type==="puddle"){
      px(x, GROUND_Y-10, hz.w, 10, "#1d4ed8");
      px(x+6, GROUND_Y-8, hz.w-12, 5, "rgba(255,255,255,.20)");
    }else{
      px(x, GROUND_Y-24, hz.w, 8, "#9ca3af");
      px(x+8, GROUND_Y-38, hz.w-16, 14, "#6b7280");
      px(x+10, GROUND_Y-14, 10, 10, "#111827");
      px(x+hz.w-20, GROUND_Y-14, 10, 10, "#111827");
    }
  }
}

function drawWorld(){
  px(0,0,W,H,"#8fd3ff");
  px(0,120,W,70,"#1f7a3a");
  px(0,150,W,50,"#14532d");
  px(0,GROUND_Y,W,80,"#2f7d2a");
  px(0,GROUND_Y-14,W,6,"rgba(255,255,255,.35)");

  drawStores();
  drawHazards();

  if(!inBossArena){
    for(const e of enemies){ if(e.alive) (e.type==="werewolf"?drawWerewolf(e):drawVampire(e)); }
    for(const t of tourists){ if(t.alive) drawTourist(t); }
    drawElk();
  }else{
    ctx.fillStyle="rgba(0,0,0,.08)";
    ctx.fillRect(0,0,W,H);
    drawSassy();
  }

  drawBullets();
  drawTom();
}

/* ---------- Win ---------- */
function win(){
  if(won) return;
  won=true;
  mode="WIN";
  setPaused(true);
  showBubble("HOT CASE SECURED.\n\nTom gets the chicken strips and JoJos.\nA tourist asks if elk are deer that got promoted.\n\nHit Reset to play again.");
}

/* ---------- ACTION (single button) ---------- */
function doAction(){
  if(paused){
    if(mode==="STORE"){ buyStore(); closeInteraction(); return; }
    if(mode==="TOURIST"){
      if(activeTourist && activeTourist.annoying){ closeInteraction(); return; }
      if(answerChoices.length){
        const correct = (answerIndex===correctIndex);
        if(correct){ cash += 8 + ((Math.random()*6)|0); sfxCoin(); }
        else{ timeLeft = Math.max(0, timeLeft-3); sfxHit(); }
      }
      closeInteraction();
      return;
    }
  }

  if(tom.carry){ throwTourist(tom.carry); return; }

  const s = storeAtDoor();
  if(s){ openStore(s); return; }

  for(const t of tourists){
    if(!t.alive) continue;
    if(aabb(rect(tom.x,tom.y,tom.w,tom.h), rect(t.x,t.y,t.w,t.h))){
      if(!t.known){ openTourist(t); return; }
      if(t.throwable){ tom.carry=t; return; }
      openTourist(t); return;
    }
  }

  if(tom.ammo>0){
    if(spawnBullet()) return;
  }

  if(!tom.big && tom.beer>0){
    tom.beer -= 1;
    setTomSize(true);
    sfxCoin();
  }
}

/* ---------- Main loop ---------- */
let last=performance.now();
let prevJump=false, prevAction=false, prevLeft=false, prevRight=false;

function loop(now){
  const dt = clamp((now-last)/1000, 0, 1/20);
  last = now;

  const jumpTap = input.jump && !prevJump;
  const actionTap = input.action && !prevAction;
  const leftTap = input.left && !prevLeft;
  const rightTap = input.right && !prevRight;

  prevJump=input.jump;
  prevAction=input.action;
  prevLeft=input.left;
  prevRight=input.right;

  if(running && !won){
    if(!paused){
      timeLeft = Math.max(0, timeLeft - dt);

      if(inBossArena) setTempo(130);
      else if(tom.x > 1800) setTempo(140);
      else if(tom.x > 1400) setTempo(150);
      else setTempo(165);

      if(jumpTap && tom.onGround){
        tom.vy = TOM_JUMP_VY;
        tom.onGround=false;
        sfxJump();
      }

      updateTom(dt);

      const desired = tom.x - 170;
      const maxCam = Math.max(0, WORLD_W - W);
      camX = clamp(desired, 0, maxCam);

      updateBullets(dt);

      if(!inBossArena){
        updateEnemies(dt);
        updateTourists(dt);
        updateHazards(dt);
        maybeSpawnElk();
        updateElk(dt);
      }else{
        if(!sassy.started) startBoss();
        updateBoss(dt);
      }

      checkBossArenaEntry();

      if(timeLeft<=0){
        setPaused(true);
        showBubble("Time‚Äôs up.\nThe hot case is gone.\n\nReset to try again.");
      }
    }else{
      if(mode==="TOURIST" && answerChoices.length){
        if(leftTap) answerNav(-1);
        if(rightTap) answerNav(+1);
      }
      if(jumpTap) closeInteraction();
    }

    if(actionTap) doAction();

    const thrift = stores.find(s=>s.key==="THRIFT");
    if(thrift && inBossArena && !sassy.active){
      if(aabb(rect(tom.x,tom.y,tom.w,tom.h), doorRect(thrift))) win();
    }
  }

  hudBeer.textContent = tom.beer;
  hudCash.textContent = cash;
  hudAmmo.textContent = tom.ammo;
  hudTime.textContent = (timeLeft|0);
  hudZone.textContent = inBossArena ? "THRIFTWAY LOT" : "FORKS AVE";

  drawWorld();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>

</body>
</html>
