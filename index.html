<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Forks Ave ‚Äî JoJos Run</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">

<style>
*{
  -webkit-user-select:none;
  user-select:none;
  -webkit-touch-callout:none;
  -webkit-tap-highlight-color:transparent;
}
html,body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  background:#071021;
  overflow:hidden;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
}
#wrap{
  width:100vw;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
canvas{
  width:100vw;
  max-width:520px;
  height:100vh;
  max-height:960px;
  background:#8fd3ff;
  image-rendering:pixelated;
  border-radius:14px;
  touch-action:none;
}
#hud{
  position:fixed;
  top:0;
  left:0;
  right:0;
  padding:8px 10px;
  background:rgba(0,0,0,.75);
  color:#fff;
  display:flex;
  justify-content:space-between;
  z-index:10;
  font-size:14px;
}
#controls{
  position:fixed;
  bottom:10px;
  left:0;
  right:0;
  display:flex;
  gap:8px;
  padding:0 10px;
  z-index:10;
}
.ctrl{
  flex:1;
  padding:14px 10px;
  font-size:16px;
  font-weight:800;
  border:none;
  border-radius:16px;
  background:#111827;
  color:white;
}
.ctrl.jump{ background:#16a34a; }
.ctrl.action{ background:#2563eb; }

.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:20;
}
.panel{
  width:92%;
  max-width:520px;
  background:#0f1e35;
  color:white;
  padding:18px;
  border-radius:18px;
}
.panel h1{ margin:0 0 10px; }
.panel p{ line-height:1.35; }
.panel button{
  width:100%;
  margin-top:10px;
  padding:14px;
  font-size:18px;
  font-weight:900;
  border:none;
  border-radius:16px;
  background:#2563eb;
  color:white;
}
.panel button.secondary{
  background:#1f2937;
}
#bubble{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:120px;
  width:min(520px,92vw);
  background:#fff;
  color:#0b1220;
  border-radius:16px;
  padding:12px;
  box-shadow:0 8px 24px rgba(0,0,0,.35);
  z-index:30;
  display:none;
  white-space:pre-line;
}
</style>
</head>

<body>

<div id="hud">
  <div>üç∫ <span id="hudBeer">6</span> | üíµ $<span id="hudCash">0</span> | ‚è± <span id="hudTime">160</span></div>
  <button onclick="location.reload()">Reset</button>
</div>

<div id="wrap">
  <canvas id="game" width="360" height="640"></canvas>
</div>

<div id="controls">
  <button class="ctrl" id="btnLeft">‚¨Ö</button>
  <button class="ctrl jump" id="btnJump">JUMP</button>
  <button class="ctrl" id="btnRight">‚û°</button>
  <button class="ctrl action" id="btnAction">ACTION</button>
</div>

<div class="overlay" id="startScreen">
  <div class="panel">
    <h1>Forks Ave ‚Äî JoJos Run</h1>
    <p>The crew bus just dropped Tom off at the 76.</p>
    <p>Get to Thriftway before the tourists clear out the hot case.</p>
    <p>Talk first. Some tourists tip. Some can be thrown.</p>
    <button id="startBtn">START</button>
    <button class="secondary" id="howBtn">CONTROLS / GOAL</button>
  </div>
</div>

<div class="overlay" id="howScreen" style="display:none;">
  <div class="panel">
    <h1>How to Play</h1>
    <p><b>Mobile:</b> On-screen buttons</p>
    <p><b>Keyboard:</b> A/D or ‚Üê ‚Üí move, W/‚Üë jump, Space/Enter = action</p>
    <p><b>Action:</b> Talk ‚Ä¢ Grab ‚Ä¢ Throw ‚Ä¢ Drink beer</p>
    <p><b>Goal:</b> Defeat Sasquatch, enter Thriftway</p>
    <button id="backBtn">BACK</button>
  </div>
</div>

<div id="bubble"></div>

<script>
/* ======================================================
   HALF 1 OF 2 ‚Äî CORE STATE + AUDIO + INPUT
   (NO GAME LOOP YET ‚Äî THIS IS CORRECT)
====================================================== */

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const hudBeer = document.getElementById("hudBeer");
const hudCash = document.getElementById("hudCash");
const hudTime = document.getElementById("hudTime");

const bubble = document.getElementById("bubble");
function showBubble(t){ bubble.style.display="block"; bubble.textContent=t; }
function hideBubble(){ bubble.style.display="none"; bubble.textContent=""; }

let running = false;
let paused = false;

/* ---------- AUDIO (fixed, persistent) ---------- */
let audioCtx=null, musicTimer=null, tempoMs=165, noteIdx=0, audioUnlocked=false;
const melody=[262,294,330,392,440,392,330,294,262,330,392,523,587,523,392,330];

function unlockAudio(){
  if(audioUnlocked) return;
  audioUnlocked=true;
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  startMusic();
}
function playTone(f,d=0.12,v=0.04){
  if(!audioCtx) return;
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type="square"; o.frequency.value=f; g.gain.value=v;
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime+d);
}
function startMusic(){
  if(musicTimer) return;
  musicTimer=setInterval(()=>playTone(melody[noteIdx++%melody.length]),tempoMs);
}
function setTempo(ms){
  if(ms===tempoMs) return;
  tempoMs=ms;
  if(musicTimer){ clearInterval(musicTimer); musicTimer=null; }
  if(audioUnlocked) startMusic();
}

/* ---------- INPUT ---------- */
const input={left:false,right:false,jump:false,action:false};

function bind(id,key){
  const el=document.getElementById(id);
  el.addEventListener("pointerdown",e=>{e.preventDefault();input[key]=true;unlockAudio();},{passive:false});
  el.addEventListener("pointerup",e=>{e.preventDefault();input[key]=false;},{passive:false});
  el.addEventListener("pointerleave",()=>input[key]=false);
}
bind("btnLeft","left");
bind("btnRight","right");
bind("btnJump","jump");
bind("btnAction","action");

window.addEventListener("keydown",e=>{
  unlockAudio();
  if(e.key==="ArrowLeft"||e.key==="a") input.left=true;
  if(e.key==="ArrowRight"||e.key==="d") input.right=true;
  if(e.key==="ArrowUp"||e.key==="w") input.jump=true;
  if(e.key===" "||e.key==="Enter") input.action=true;
});
window.addEventListener("keyup",e=>{
  if(e.key==="ArrowLeft"||e.key==="a") input.left=false;
  if(e.key==="ArrowRight"||e.key==="d") input.right=false;
  if(e.key==="ArrowUp"||e.key==="w") input.jump=false;
  if(e.key===" "||e.key==="Enter") input.action=false;
});

/* ---------- UI ---------- */
document.getElementById("startBtn").onclick=()=>{
  document.getElementById("startScreen").style.display="none";
  running=true;
  unlockAudio();
};
document.getElementById("howBtn").onclick=()=>{
  document.getElementById("howScreen").style.display="flex";
};
document.getElementById("backBtn").onclick=()=>{
  document.getElementById("howScreen").style.display="none";
};
<script>
/* ======================================================
   HALF 2 OF 2 ‚Äî GAMEPLAY + LOOP
   Fixes included:
   - Big hit no longer instantly resets (i-frames via tom.hurt)
   - Hazards no longer wipe time (cooldown)
   - Music doesn't cut out (setTempo is no-op unless changed, in HALF 1)
   - Dialog pauses game (safe)
   - No Frogger
====================================================== */

/* ---------- SFX wrappers ---------- */
function sfxJump(){ playTone(740,0.07,0.06); }
function sfxStomp(){ playTone(220,0.08,0.07); }
function sfxHit(){ playTone(160,0.10,0.07); }
function sfxCoin(){ playTone(880,0.06,0.05); playTone(1174,0.06,0.04); }
function sfxThrow(){ playTone(330,0.06,0.06); }

/* ---------- Helpers ---------- */
function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
function rect(x,y,w,h){ return {x,y,w,h}; }
function aabb(a,b){ return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y; }
function px(x,y,w,h,c){ ctx.fillStyle=c; ctx.fillRect(x,y,w,h); }
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=(Math.random()*(i+1))|0;
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

/* ---------- World constants ---------- */
const W = canvas.width;
const H = canvas.height;
const WORLD_W = 2600;
const GROUND_Y = 560;
const GRAVITY = 2200;

const BUILD_Y = GROUND_Y - 210;
const BUILD_H = 190;

/* ---------- Stores (door-only) ---------- */
const stores = [
  { key:"76",     name:"Evergreen 76",   x:  40, w: 220, color:"#9b1c1c", door:{dx: 95,  w: 34} },
  { key:"SHELL",  name:"Shell",          x: 330, w: 220, color:"#d4a300", door:{dx: 92,  w: 34} },
  { key:"CHINOOK",name:"Chinook Rx",     x: 610, w: 240, color:"#0f766e", door:{dx: 104, w: 34} },
  { key:"TRUE",   name:"True Value",     x: 910, w: 240, color:"#5b21b6", door:{dx: 104, w: 34} },
  { key:"TRANSIT",name:"Transit",        x: 1220,w: 220, color:"#334155", door:{dx: 92,  w: 34} },
  { key:"CARWASH",name:"Car Wash",       x: 1470,w: 210, color:"#1d4ed8", door:{dx: 88,  w: 34} },
  { key:"SASQ",   name:"Sasquatch Shop", x: 1730,w: 240, color:"#6d4c41", door:{dx: 104, w: 34} },
  { key:"THRIFT", name:"Thriftway",      x: 2020,w: 360, color:"#b50000", door:{dx: 160, w: 48} },
];

function doorRect(s){ return rect(s.x + s.door.dx, GROUND_Y-84, s.door.w, 84); }
function storeAtDoor(){
  const tr=rect(tom.x,tom.y,tom.w,tom.h);
  for(const s of stores){
    if(aabb(tr, doorRect(s))) return s;
  }
  return null;
}

/* ---------- Game state ---------- */
let won=false;
let timeLeft=160;
let cash=0;
let camX=0;

function setPaused(v){ paused=v; }

/* ---------- Player ---------- */
const tom = {
  x: 90, y: GROUND_Y-96,
  w: 44, h: 96,
  vx:0, vy:0,
  onGround:false,
  big:true,
  beer:6,
  facing:1,
  carry:null,
  hurt:0 // i-frames timer
};

/* ---------- Tourists ---------- */
function makeTourist(x){
  return {
    x, y:GROUND_Y-82,
    w:38, h:82,
    vx:(Math.random()<0.5?-40:40),
    alive:true,
    known:false,
    annoying:null,
    smart:false,
    throwable:false,
    sliding:false,
    slideV:0
  };
}
let tourists = [
  makeTourist(420),
  makeTourist(680),
  makeTourist(980),
  makeTourist(1320),
  makeTourist(1600),
];

/* ---------- Enemies ---------- */
function makeEnemy(type,x){
  return {
    type,
    x, y:GROUND_Y-76,
    w:42, h:76,
    vx:(type==="werewolf"?95:75),
    vy:0,
    winged:(type==="vampire"),
    alive:true
  };
}
let enemies = [
  makeEnemy("vampire", 760),
  makeEnemy("werewolf", 1050),
  makeEnemy("vampire", 1380),
  makeEnemy("werewolf", 1620),
];

/* ---------- Elk hazard ---------- */
const elk = { active:false, x:0, y:GROUND_Y-54, w:90, h:48, vx:-560 };

/* ---------- Boss arena ---------- */
let inBossArena=false;
const sassy = {
  active:false, started:false, hp:6,
  x:2140, y:GROUND_Y-140, w:110, h:140,
  vx:0, vy:0, onGround:false, jumpT:0.8
};

/* ---------- Obstacles (no Frogger) ---------- */
const hazards = [
  { x: 520,  w: 52, type:"pothole" },
  { x: 1120, w: 70, type:"puddle" },
  { x: 1460, w: 60, type:"cart"   },
];
let hazardCooldown = 0;

function hazardRect(hz){ return rect(hz.x, GROUND_Y-18, hz.w, 18); }

/* ---------- Dialog state ---------- */
let mode="RUN"; // RUN | TOURIST | STORE | WIN
let activeTourist=null;
let activeStore=null;
let answerChoices=[];
let answerIndex=0;
let correctIndex=0;

const dumbQs = [
  "‚ÄúWhen do the deer turn into elk?‚Äù",
  "‚ÄúWhere can we find Edward?‚Äù",
  "‚ÄúDo vampires sparkle in the shade or only in drizzle?‚Äù",
  "‚ÄúIs the Cullen house on Airbnb?‚Äù",
  "‚ÄúDo park rangers herd whales through the Peugeot sound?‚Äù",
  "‚ÄúIs Jacob available for birthday parties?‚Äù",
  "‚ÄúWhere is the vampire sparkle viewing area?‚Äù"
];

const directionQs = [
  { q:"‚ÄúHow do we get to Thriftway?‚Äù",
    correct:"Go down Forks Ave until the big red sign.",
    wrong:[
      "Follow the whales through Peugeot Sound.",
      "Ask a vampire for Yelp directions.",
      "Wait for Edward to appear and lead you."
    ]
  },
  { q:"‚ÄúWhere‚Äôs Chinook Pharmacy?‚Äù",
    correct:"Stay on the main strip‚Äîkeep walking.",
    wrong:[
      "Turn where the deer become elk.",
      "Cross into La Push and howl twice.",
      "It‚Äôs behind the sparkle treaty line."
    ]
  },
  { q:"‚ÄúWhere‚Äôs the Transit Center?‚Äù",
    correct:"Keep to Forks Ave‚Äîwatch for the bus stop.",
    wrong:[
      "Summon a werewolf rideshare.",
      "Ask Sassy. He runs dispatch.",
      "Go back to the 76 and request a teleport."
    ]
  }
];

function renderChoices(){
  let out="";
  for(let i=0;i<answerChoices.length;i++){
    out += (i===answerIndex ? "‚ñ∂ " : "  ") + answerChoices[i] + "\n";
  }
  return out.trimEnd();
}

function closeInteraction(){
  mode="RUN";
  activeTourist=null;
  activeStore=null;
  answerChoices=[];
  hideBubble();
  setPaused(false);
}

/* ---------- Stores ---------- */
function openStore(s){
  mode="STORE";
  setPaused(true);
  activeStore=s;

  let text=`üè™ ${s.name}\n`;
  if(s.key==="SHELL")   text += "1) Buy beer case (+6) ‚Äî $10\n";
  if(s.key==="CHINOOK") text += "1) Blister cream ‚Äî $8\n";
  if(s.key==="TRUE")    text += "1) Ammo (+3) ‚Äî $9\n";
  if(s.key==="SASQ")    text += "1) Earrings (wife) ‚Äî $12 (+15s)\n";
  if(s.key==="CARWASH") text += "1) Wash car +$5 (free)\n";
  if(s.key==="TRANSIT") text += "1) Bus closer to Thriftway ‚Äî $20\n";
  if(s.key==="THRIFT"){
    if(!inBossArena) text += "Parking lot ahead‚Ä¶\n";
    else text += (sassy.active ? "Door locked until Sassy is defeated.\n" : "Door unlocked.\n");
  }
  text += "\nACTION buys option 1 ‚Ä¢ JUMP closes";
  showBubble(text);
}

function buyStore(){
  const s=activeStore;
  if(!s) return;

  if(s.key==="SHELL" && cash>=10){ cash-=10; tom.beer+=6; sfxCoin(); }
  else if(s.key==="CHINOOK" && cash>=8){ cash-=8; sfxCoin(); }
  else if(s.key==="TRUE" && cash>=9){ cash-=9; sfxCoin(); }
  else if(s.key==="SASQ" && cash>=12){ cash-=12; timeLeft+=15; sfxCoin(); }
  else if(s.key==="CARWASH"){ cash+=5; sfxCoin(); }
  else if(s.key==="TRANSIT" && cash>=20 && !inBossArena){
    cash-=20;
    tom.x=1880; tom.y=GROUND_Y-tom.h;
    tom.vx=0; tom.vy=0;
    sfxCoin();
  }
}

/* ---------- Tourists ---------- */
function openTourist(t){
  mode="TOURIST";
  setPaused(true);
  activeTourist=t;
  t.known=true;

  if(t.annoying===null){
    t.annoying = Math.random() < 0.55;
    t.smart = !t.annoying;
    t.throwable = t.annoying; // ONLY annoying tourists throwable
  }

  if(t.annoying){
    const q=dumbQs[(Math.random()*dumbQs.length)|0];
    showBubble(q + "\n\nACTION closes");
    return;
  }

  const dq=directionQs[(Math.random()*directionQs.length)|0];
  const choices=shuffle([dq.correct, ...dq.wrong]);
  answerChoices=choices;
  answerIndex=0;
  correctIndex=choices.indexOf(dq.correct);

  showBubble(dq.q + "\n\n" + renderChoices() +
    "\n\nLEFT/RIGHT choose ‚Ä¢ ACTION confirm ‚Ä¢ JUMP closes");
}

function throwTourist(t){
  t.sliding=true;
  t.slideV = 720 * tom.facing;
  tom.carry=null;
  sfxThrow();
}

/* ---------- Combat / damage ---------- */
function stompOn(targetY){
  // big stomp window
  return tom.vy > 90 && (tom.y + tom.h - targetY) < 44;
}

function hitTom(knockDir=0){
  if(tom.hurt>0) return;      // i-frames
  tom.hurt = 0.85;
  sfxHit();

  if(tom.big){
    tom.big=false;            // big -> small only
    tom.vy=-520;
    tom.vx=520*(knockDir||-tom.facing);
  }else{
    resetTo76();
  }
}

function resetTo76(){
  tom.x=90; tom.y=GROUND_Y-tom.h;
  tom.vx=0; tom.vy=0;
  tom.onGround=false;
  tom.big=true;
  tom.beer=6;
  tom.hurt=0;

  cash=0;
  timeLeft=160;

  inBossArena=false;
  sassy.active=false;
  sassy.started=false;

  enemies=[
    makeEnemy("vampire", 760),
    makeEnemy("werewolf", 1050),
    makeEnemy("vampire", 1380),
    makeEnemy("werewolf", 1620),
  ];
  tourists=[
    makeTourist(420),
    makeTourist(680),
    makeTourist(980),
    makeTourist(1320),
    makeTourist(1600),
  ];
}

/* ---------- Update functions ---------- */
function updateTom(dt){
  tom.hurt = Math.max(0, tom.hurt - dt);

  const speed=250;
  tom.vx=0;
  if(input.left){ tom.vx=-speed; tom.facing=-1; }
  if(input.right){ tom.vx= speed; tom.facing= 1; }

  tom.vy += GRAVITY*dt;
  tom.x += tom.vx*dt;
  tom.y += tom.vy*dt;

  if(tom.y >= GROUND_Y - tom.h){
    tom.y = GROUND_Y - tom.h;
    tom.vy = 0;
    tom.onGround=true;
  }else{
    tom.onGround=false;
  }

  tom.x = clamp(tom.x, 0, WORLD_W - tom.w);
}

function updateEnemies(dt){
  for(const e of enemies){
    if(!e.alive) continue;

    if(e.type==="vampire" && e.winged && Math.random()<0.012){
      e.vy=-740;
    }

    e.vy += GRAVITY*dt;
    e.x  += e.vx*dt;
    e.y  += e.vy*dt;

    if(e.x < 640)  e.vx = Math.abs(e.vx);
    if(e.x > 1720) e.vx = -Math.abs(e.vx);

    if(e.y >= GROUND_Y - e.h){
      e.y = GROUND_Y - e.h;
      e.vy = 0;
    }

    if(tom.hurt>0) continue;

    const tr=rect(tom.x,tom.y,tom.w,tom.h);
    const er=rect(e.x,e.y,e.w,e.h);
    if(aabb(tr,er)){
      const stomp = stompOn(e.y);
      if(stomp){
        if(e.type==="vampire" && e.winged){
          e.winged=false;
        }else{
          e.alive=false;
        }
        tom.vy=-680;
        sfxStomp();
      }else{
        hitTom(Math.sign(tom.x - e.x) || 1);
      }
    }
  }
}

function updateTourists(dt){
  for(const t of tourists){
    if(!t.alive) continue;

    if(tom.carry===t){
      t.x = tom.x + (tom.facing>0 ? 20 : -20);
      t.y = tom.y + 12;
      continue;
    }

    if(t.sliding){
      t.x += t.slideV*dt;
      t.y = GROUND_Y - t.h;

      const tr=rect(t.x,t.y,t.w,t.h);
      for(const e of enemies){
        if(!e.alive) continue;
        if(aabb(tr, rect(e.x,e.y,e.w,e.h))){
          e.alive=false;
          t.alive=false;
          sfxStomp();
          break;
        }
      }
      if(Math.abs(t.x - tom.x) > 900) t.alive=false;
      continue;
    }

    t.x += t.vx*dt;
    if(Math.random()<0.01) t.vx *= -1;
    t.x = clamp(t.x, 220, 1850);
  }
}

function updateHazards(dt){
  hazardCooldown = Math.max(0, hazardCooldown - dt);
  if(hazardCooldown>0) return;

  const tr=rect(tom.x,tom.y,tom.w,tom.h);
  for(const hz of hazards){
    const hr=hazardRect(hz);
    if(aabb(tr,hr) && tom.onGround){
      hazardCooldown = 0.95; // prevents time wipe
      timeLeft = Math.max(0, timeLeft - 4);
      if(hz.type==="cart" && tom.hurt===0) hitTom(tom.facing);
      return;
    }
  }
}

function maybeSpawnElk(){
  if(inBossArena || elk.active) return;
  if(tom.x > 1150 && Math.random()<0.012){
    elk.active=true;
    elk.x = tom.x + 520;
  }
}
function updateElk(dt){
  if(!elk.active) return;
  elk.x += elk.vx*dt;
  if(elk.x < tom.x - 900) elk.active=false;

  if(tom.hurt>0) return;

  const tr=rect(tom.x,tom.y,tom.w,tom.h);
  const er=rect(elk.x,elk.y,elk.w,elk.h);
  if(aabb(tr,er)){
    const stomp=stompOn(elk.y);
    if(stomp){
      elk.active=false;
      tom.vy=-700;
      sfxStomp();
    }else{
      hitTom(Math.sign(tom.x - elk.x) || 1);
      elk.active=false;
    }
  }
}

/* ---------- Boss ---------- */
function checkBossArenaEntry(){
  if(inBossArena) return;
  if(tom.x > 1950){
    inBossArena=true;
    enemies.forEach(e=>e.alive=false);
    tourists.forEach(t=>t.alive=false);
  }
}
function startBoss(){
  sassy.active=true;
  sassy.started=true;
  sassy.hp=6;
  sassy.x=2140;
  sassy.y=GROUND_Y-sassy.h;
  sassy.vx=-240;
  sassy.vy=0;
  sassy.onGround=true;
  sassy.jumpT=0.8;
}
function updateBoss(dt){
  if(!sassy.active) return;

  const dir = Math.sign(tom.x - sassy.x) || 1;
  sassy.vx = dir * 320;

  sassy.jumpT -= dt;
  if(sassy.jumpT<=0 && sassy.onGround){
    sassy.vy=-1020;
    sassy.onGround=false;
    sassy.jumpT = 0.55 + Math.random()*0.55;
  }

  sassy.vy += GRAVITY*dt;
  sassy.x  += sassy.vx*dt;
  sassy.y  += sassy.vy*dt;

  sassy.x = clamp(sassy.x, 1960, 2360);

  if(sassy.y >= GROUND_Y - sassy.h){
    sassy.y = GROUND_Y - sassy.h;
    sassy.vy = 0;
    sassy.onGround=true;
  }

  if(tom.hurt>0) return;

  const tr=rect(tom.x,tom.y,tom.w,tom.h);
  const br=rect(sassy.x,sassy.y,sassy.w,sassy.h);
  if(aabb(tr,br)){
    const stomp=stompOn(sassy.y);
    if(stomp){
      sassy.hp -= 1;
      tom.vy=-760;
      sfxStomp();
      if(sassy.hp<=0) sassy.active=false;
    }else{
      hitTom(dir);
    }
  }
}

/* ---------- Rendering ---------- */
function drawStores(){
  ctx.save();
  ctx.translate(-camX,0);
  for(const s of stores){
    px(s.x, BUILD_Y, s.w, BUILD_H, s.color);
    px(s.x, BUILD_Y, s.w, 10, "rgba(0,0,0,.25)");
    ctx.fillStyle="rgba(255,255,255,.92)";
    ctx.font="bold 14px system-ui";
    ctx.textAlign="center";
    ctx.fillText(s.name, s.x + s.w/2, BUILD_Y + 26);

    for(let i=0;i<Math.floor(s.w/70);i++){
      px(s.x+16+i*70, BUILD_Y+54, 42, 22, "rgba(255,255,255,.18)");
    }

    const d=doorRect(s);
    px(d.x, d.y, d.w, d.h, "#111827");
    px(d.x+4, d.y+14, d.w-8, 18, "rgba(255,255,255,.25)");
  }
  ctx.restore();
}

function drawHazards(){
  ctx.save();
  ctx.translate(-camX,0);
  for(const hz of hazards){
    if(hz.type==="pothole"){
      px(hz.x, GROUND_Y-16, hz.w, 16, "#1f2937");
      px(hz.x+6, GROUND_Y-12, hz.w-12, 8, "rgba(255,255,255,.10)");
    }else if(hz.type==="puddle"){
      px(hz.x, GROUND_Y-10, hz.w, 10, "#1d4ed8");
      px(hz.x+6, GROUND_Y-8, hz.w-12, 5, "rgba(255,255,255,.20)");
    }else{
      px(hz.x, GROUND_Y-24, hz.w, 8, "#9ca3af");
      px(hz.x+8, GROUND_Y-38, hz.w-16, 14, "#6b7280");
      px(hz.x+10, GROUND_Y-14, 10, 10, "#111827");
      px(hz.x+hz.w-20, GROUND_Y-14, 10, 10, "#111827");
    }
  }
  ctx.restore();
}

function drawTom(){
  const x=tom.x-camX, y=tom.y;
  // blink when invincible
  if(tom.hurt>0 && ((tom.hurt*10)|0)%2===0) return;

  px(x+8, y+92, 28, 6, "rgba(0,0,0,.25)");
  px(x+8, y+6, 28, 10, "#ffcc00");
  px(x+6, y+14, 32, 6, "#eab308");
  px(x+12, y+20, 20, 18, "#f2c9a0");
  px(x+12, y+34, 20, 8, "#2b2b2b");
  px(x+16, y+26, 4, 4, "#111827");
  px(x+24, y+26, 4, 4, "#111827");
  px(x+10, y+40, 24, 28, "#b22222");
  px(x+10, y+46, 24, 4, "#1e3a8a");
  px(x+10, y+54, 24, 4, "#1e3a8a");
  px(x+10, y+62, 24, 3, "#1e3a8a");
  px(x+4,  y+44, 6, 22, "#b22222");
  px(x+34, y+44, 6, 22, "#b22222");
  px(x+4,  y+66, 6, 6, "#f2c9a0");
  px(x+34, y+66, 6, 6, "#f2c9a0");
  px(x+12, y+68, 10, 18, "#1f2937");
  px(x+22, y+68, 10, 18, "#1f2937");
  px(x+10, y+86, 12, 8, "#111827");
  px(x+22, y+86, 12, 8, "#111827");
  px(x+12, y+94, 8, 2, "#9ca3af");
  px(x+24, y+94, 8, 2, "#9ca3af");
  if(!tom.big) px(x+4, y+6, 36, 90, "rgba(255,255,255,.12)");
}

function drawTourist(t){
  const x=t.x-camX, y=t.y;
  px(x+8,y+10,26,8, t.annoying ? "#ff7a18" : "#16a34a");
  px(x+12,y+18,18,16,"#f2c9a0");
  px(x+16,y+24,3,3,"#111827");
  px(x+23,y+24,3,3,"#111827");
  px(x+10,y+34,22,24,"#64748b");
  px(x+14,y+40,14,8,"#111827");
  px(x+4,y+40,8,12,"#94a3b8");
  px(x+12,y+58,9,18,"#0f172a");
  px(x+21,y+58,9,18,"#0f172a");
  px(x+12,y+76,9,6,"#111827");
  px(x+21,y+76,9,6,"#111827");
}

function drawWerewolf(e){
  const x=e.x-camX, y=e.y;
  px(x+6,y+14,32,38,"#6b4a2e");
  px(x+10,y+22,24,18,"#4b2f1a");
  px(x+26,y+28,12,8,"#2b1a0f");
  px(x+14,y+28,3,3,"#111827");
  px(x+20,y+28,3,3,"#111827");
  px(x+10,y+52,12,18,"#111827");
  px(x+22,y+52,12,18,"#111827");
  px(x+8,y+70,14,6,"#111827");
  px(x+22,y+70,14,6,"#111827");
}

function drawVampire(e){
  const x=e.x-camX, y=e.y;
  if(e.winged){
    px(x-8,y+18,10,18,"rgba(0,0,0,.35)");
    px(x+40,y+18,10,18,"rgba(0,0,0,.35)");
  }
  px(x+8,y+14,28,40,"#3b1d5c");
  px(x+14,y+20,16,14,"#f3e8ff");
  px(x+17,y+24,3,3,"#111827");
  px(x+24,y+24,3,3,"#111827");
  px(x+20,y+32,4,3,"#7c2d12");
  px(x+12,y+54,10,16,"#111827");
  px(x+22,y+54,10,16,"#111827");
  px(x+10,y+70,12,6,"#111827");
  px(x+22,y+70,12,6,"#111827");
}

function drawElk(){
  if(!elk.active) return;
  const x=elk.x-camX, y=elk.y;
  px(x, y, elk.w, elk.h, "#c68642");
  px(x+14, y+14, 20, 6, "rgba(0,0,0,.22)");
  px(x+60, y+6, 10, 10, "#8b5a2b");
}

function drawSassy(){
  if(!sassy.active) return;
  const x=sassy.x-camX, y=sassy.y;
  px(x+8,y+10,94,120,"#3b2f2f");
  px(x+24,y+30,60,38,"#2b1f1f");
  px(x+38,y+42,8,8,"#111827");
  px(x+66,y+42,8,8,"#111827");
  px(x+46,y+62,28,8,"#111827");
  px(x-8,y+44,20,50,"#3b2f2f");
  px(x+102,y+44,20,50,"#3b2f2f");
  ctx.fillStyle="rgba(255,255,255,.92)";
  ctx.font="bold 14px system-ui";
  ctx.textAlign="left";
  ctx.fillText("SASSY HP: "+sassy.hp, x, y-8);
}

function drawWorld(){
  px(0,0,W,H,"#8fd3ff");
  px(0,120,W,70,"#1f7a3a");
  px(0,150,W,50,"#14532d");
  px(0,GROUND_Y,W,80,"#2f7d2a");
  px(0,GROUND_Y-14,W,6,"rgba(255,255,255,.35)");

  drawStores();
  drawHazards();

  ctx.save();
  ctx.translate(-camX,0);

  if(!inBossArena){
    for(const e of enemies){
      if(!e.alive) continue;
      if(e.type==="werewolf") drawWerewolf(e);
      else drawVampire(e);
    }
    for(const t of tourists){
      if(!t.alive) continue;
      drawTourist(t);
    }
    drawElk();
  }else{
    ctx.fillStyle="rgba(0,0,0,.08)";
    ctx.fillRect(camX,0,W,H);
    drawSassy();
  }

  drawTom();
  ctx.restore();
}

/* ---------- Win ---------- */
function win(){
  if(won) return;
  won=true;
  mode="WIN";
  setPaused(true);
  showBubble("HOT CASE SECURED.\n\nTom gets the chicken strips and JoJos.\nA tourist asks if elk are deer that got promoted.\n\nHit Reset to play again.");
}

/* ---------- Action handler (unified button) ---------- */
function doAction(){
  if(paused){
    if(mode==="STORE"){ buyStore(); closeInteraction(); return; }
    if(mode==="TOURIST"){
      if(activeTourist && activeTourist.annoying){ closeInteraction(); return; }
      if(answerChoices.length){
        const correct=(answerIndex===correctIndex);
        if(correct){ cash += 8 + ((Math.random()*6)|0); sfxCoin(); }
        else{ timeLeft = Math.max(0, timeLeft-3); sfxHit(); }
      }
      closeInteraction();
      return;
    }
  }

  if(tom.carry){ throwTourist(tom.carry); return; }

  const s=storeAtDoor();
  if(s){ openStore(s); return; }

  for(const t of tourists){
    if(!t.alive) continue;
    if(aabb(rect(tom.x,tom.y,tom.w,tom.h), rect(t.x,t.y,t.w,t.h))){
      if(!t.known){ openTourist(t); return; }
      if(t.throwable){ tom.carry=t; return; }
      openTourist(t);
      return;
    }
  }

  // drink beer anytime (meaningful when small)
  if(!tom.big && tom.beer>0){
    tom.beer -= 1;
    tom.big = true;
    sfxCoin();
    return;
  }
}

/* ---------- Answer nav using movement controls while paused ---------- */
function answerNav(dir){
  if(!paused || mode!=="TOURIST" || answerChoices.length===0) return;
  answerIndex = (answerIndex + dir + answerChoices.length) % answerChoices.length;
  const q = bubble.textContent.split("\n\n")[0];
  showBubble(q + "\n\n" + renderChoices() + "\n\nLEFT/RIGHT choose ‚Ä¢ ACTION confirm ‚Ä¢ JUMP closes");
}

/* ---------- Main loop (edge-detect taps) ---------- */
let last=performance.now();
let prevJump=false, prevAction=false, prevLeft=false, prevRight=false;

function loop(now){
  const dt = clamp((now-last)/1000, 0, 1/20);
  last = now;

  // edges
  const jumpTap = input.jump && !prevJump;
  const actionTap = input.action && !prevAction;
  const leftTap = input.left && !prevLeft;
  const rightTap = input.right && !prevRight;

  prevJump=input.jump;
  prevAction=input.action;
  prevLeft=input.left;
  prevRight=input.right;

  if(running && !won){
    if(!paused){
      timeLeft = Math.max(0, timeLeft - dt);

      // tempo ramp
      if(inBossArena) setTempo(130);
      else if(tom.x > 1800) setTempo(140);
      else if(tom.x > 1400) setTempo(150);
      else setTempo(165);

      // jump tap
      if(jumpTap && tom.onGround){
        tom.vy = -900;
        tom.onGround=false;
        sfxJump();
      }

      updateTom(dt);
      camX = clamp(tom.x - 170, 0, WORLD_W - W);

      if(!inBossArena){
        updateEnemies(dt);
        updateTourists(dt);
        updateHazards(dt);
        maybeSpawnElk();
        updateElk(dt);
      }else{
        if(!sassy.started) startBoss();
        updateBoss(dt);
      }

      checkBossArenaEntry();

      // time up
      if(timeLeft<=0){
        setPaused(true);
        showBubble("Time‚Äôs up.\nThe hot case is gone.\n\nHit Reset to try again.");
      }
    }else{
      // paused: use left/right to choose answers
      if(mode==="TOURIST" && answerChoices.length){
        if(leftTap) answerNav(-1);
        if(rightTap) answerNav(+1);
      }
      // jump closes paused dialogs
      if(jumpTap) closeInteraction();
    }

    if(actionTap) doAction();

    // win condition: boss defeated and at thrift door
    const thrift = stores.find(s=>s.key==="THRIFT");
    if(thrift && inBossArena && !sassy.active){
      if(aabb(rect(tom.x,tom.y,tom.w,tom.h), doorRect(thrift))){
        win();
      }
    }
  }

  // HUD
  hudBeer.textContent = tom.beer;
  hudCash.textContent = cash;
  hudTime.textContent = (timeLeft|0);

  drawWorld();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>

</body>
</html>
